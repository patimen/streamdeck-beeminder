import e from"stream";import t from"events";import r from"http";import n from"crypto";import{EventEmitter as o}from"node:events";import s from"zlib";import i from"buffer";import a from"https";import l from"net";import c from"tls";import u from"url";import d,{existsSync as h,readFileSync as f}from"node:fs";import p,{join as m}from"node:path";import{cwd as _}from"node:process";import{EOL as g}from"node:os";import b from"node:http";import y from"node:https";import w from"node:zlib";import v,{PassThrough as S,pipeline as E}from"node:stream";import{Buffer as T}from"node:buffer";import{types as R,promisify as k,deprecate as P}from"node:util";import{format as C}from"node:url";import{isIP as O}from"node:net";var x="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function A(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var L={exports:{}},D={BINARY_TYPES:["nodebuffer","arraybuffer","fragments"],EMPTY_BUFFER:Buffer.alloc(0),GUID:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11",kForOnEventAttribute:Symbol("kIsForOnEventAttribute"),kListener:Symbol("kListener"),kStatusCode:Symbol("status-code"),kWebSocket:Symbol("websocket"),NOOP:()=>{}};const{EMPTY_BUFFER:I}=D,B=Buffer[Symbol.species];function $(e,t,r,n,o){for(let s=0;s<o;s++)r[n+s]=e[s]^t[3&s]}function U(e,t){for(let r=0;r<e.length;r++)e[r]^=t[3&r]}if(L.exports={concat:function(e,t){if(0===e.length)return I;if(1===e.length)return e[0];const r=Buffer.allocUnsafe(t);let n=0;for(let t=0;t<e.length;t++){const o=e[t];r.set(o,n),n+=o.length}return n<t?new B(r.buffer,r.byteOffset,n):r},mask:$,toArrayBuffer:function(e){return e.length===e.buffer.byteLength?e.buffer:e.buffer.slice(e.byteOffset,e.byteOffset+e.length)},toBuffer:function e(t){if(e.readOnly=!0,Buffer.isBuffer(t))return t;let r;return t instanceof ArrayBuffer?r=new B(t):ArrayBuffer.isView(t)?r=new B(t.buffer,t.byteOffset,t.byteLength):(r=Buffer.from(t),e.readOnly=!1),r},unmask:U},!process.env.WS_NO_BUFFER_UTIL)try{const e=require("bufferutil");L.exports.mask=function(t,r,n,o,s){s<48?$(t,r,n,o,s):e.mask(t,r,n,o,s)},L.exports.unmask=function(t,r){t.length<32?U(t,r):e.unmask(t,r)}}catch(Hr){}var j=L.exports;const q=Symbol("kDone"),N=Symbol("kRun");const F=s,W=j,M=class{constructor(e){this[q]=()=>{this.pending--,this[N]()},this.concurrency=e||1/0,this.jobs=[],this.pending=0}add(e){this.jobs.push(e),this[N]()}[N](){if(this.pending!==this.concurrency&&this.jobs.length){const e=this.jobs.shift();this.pending++,e(this[q])}}},{kStatusCode:z}=D,H=Buffer[Symbol.species],V=Buffer.from([0,0,255,255]),G=Symbol("permessage-deflate"),Y=Symbol("total-length"),K=Symbol("callback"),Q=Symbol("buffers"),J=Symbol("error");let X;var Z=class{constructor(e,t,r){if(this._maxPayload=0|r,this._options=e||{},this._threshold=void 0!==this._options.threshold?this._options.threshold:1024,this._isServer=!!t,this._deflate=null,this._inflate=null,this.params=null,!X){const e=void 0!==this._options.concurrencyLimit?this._options.concurrencyLimit:10;X=new M(e)}}static get extensionName(){return"permessage-deflate"}offer(){const e={};return this._options.serverNoContextTakeover&&(e.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(e.client_no_context_takeover=!0),this._options.serverMaxWindowBits&&(e.server_max_window_bits=this._options.serverMaxWindowBits),this._options.clientMaxWindowBits?e.client_max_window_bits=this._options.clientMaxWindowBits:null==this._options.clientMaxWindowBits&&(e.client_max_window_bits=!0),e}accept(e){return e=this.normalizeParams(e),this.params=this._isServer?this.acceptAsServer(e):this.acceptAsClient(e),this.params}cleanup(){if(this._inflate&&(this._inflate.close(),this._inflate=null),this._deflate){const e=this._deflate[K];this._deflate.close(),this._deflate=null,e&&e(new Error("The deflate stream was closed while data was being processed"))}}acceptAsServer(e){const t=this._options,r=e.find((e=>!(!1===t.serverNoContextTakeover&&e.server_no_context_takeover||e.server_max_window_bits&&(!1===t.serverMaxWindowBits||"number"==typeof t.serverMaxWindowBits&&t.serverMaxWindowBits>e.server_max_window_bits)||"number"==typeof t.clientMaxWindowBits&&!e.client_max_window_bits)));if(!r)throw new Error("None of the extension offers can be accepted");return t.serverNoContextTakeover&&(r.server_no_context_takeover=!0),t.clientNoContextTakeover&&(r.client_no_context_takeover=!0),"number"==typeof t.serverMaxWindowBits&&(r.server_max_window_bits=t.serverMaxWindowBits),"number"==typeof t.clientMaxWindowBits?r.client_max_window_bits=t.clientMaxWindowBits:!0!==r.client_max_window_bits&&!1!==t.clientMaxWindowBits||delete r.client_max_window_bits,r}acceptAsClient(e){const t=e[0];if(!1===this._options.clientNoContextTakeover&&t.client_no_context_takeover)throw new Error('Unexpected parameter "client_no_context_takeover"');if(t.client_max_window_bits){if(!1===this._options.clientMaxWindowBits||"number"==typeof this._options.clientMaxWindowBits&&t.client_max_window_bits>this._options.clientMaxWindowBits)throw new Error('Unexpected or invalid parameter "client_max_window_bits"')}else"number"==typeof this._options.clientMaxWindowBits&&(t.client_max_window_bits=this._options.clientMaxWindowBits);return t}normalizeParams(e){return e.forEach((e=>{Object.keys(e).forEach((t=>{let r=e[t];if(r.length>1)throw new Error(`Parameter "${t}" must have only a single value`);if(r=r[0],"client_max_window_bits"===t){if(!0!==r){const e=+r;if(!Number.isInteger(e)||e<8||e>15)throw new TypeError(`Invalid value for parameter "${t}": ${r}`);r=e}else if(!this._isServer)throw new TypeError(`Invalid value for parameter "${t}": ${r}`)}else if("server_max_window_bits"===t){const e=+r;if(!Number.isInteger(e)||e<8||e>15)throw new TypeError(`Invalid value for parameter "${t}": ${r}`);r=e}else{if("client_no_context_takeover"!==t&&"server_no_context_takeover"!==t)throw new Error(`Unknown parameter "${t}"`);if(!0!==r)throw new TypeError(`Invalid value for parameter "${t}": ${r}`)}e[t]=r}))})),e}decompress(e,t,r){X.add((n=>{this._decompress(e,t,((e,t)=>{n(),r(e,t)}))}))}compress(e,t,r){X.add((n=>{this._compress(e,t,((e,t)=>{n(),r(e,t)}))}))}_decompress(e,t,r){const n=this._isServer?"client":"server";if(!this._inflate){const e=`${n}_max_window_bits`,t="number"!=typeof this.params[e]?F.Z_DEFAULT_WINDOWBITS:this.params[e];this._inflate=F.createInflateRaw({...this._options.zlibInflateOptions,windowBits:t}),this._inflate[G]=this,this._inflate[Y]=0,this._inflate[Q]=[],this._inflate.on("error",re),this._inflate.on("data",te)}this._inflate[K]=r,this._inflate.write(e),t&&this._inflate.write(V),this._inflate.flush((()=>{const e=this._inflate[J];if(e)return this._inflate.close(),this._inflate=null,void r(e);const o=W.concat(this._inflate[Q],this._inflate[Y]);this._inflate._readableState.endEmitted?(this._inflate.close(),this._inflate=null):(this._inflate[Y]=0,this._inflate[Q]=[],t&&this.params[`${n}_no_context_takeover`]&&this._inflate.reset()),r(null,o)}))}_compress(e,t,r){const n=this._isServer?"server":"client";if(!this._deflate){const e=`${n}_max_window_bits`,t="number"!=typeof this.params[e]?F.Z_DEFAULT_WINDOWBITS:this.params[e];this._deflate=F.createDeflateRaw({...this._options.zlibDeflateOptions,windowBits:t}),this._deflate[Y]=0,this._deflate[Q]=[],this._deflate.on("data",ee)}this._deflate[K]=r,this._deflate.write(e),this._deflate.flush(F.Z_SYNC_FLUSH,(()=>{if(!this._deflate)return;let e=W.concat(this._deflate[Q],this._deflate[Y]);t&&(e=new H(e.buffer,e.byteOffset,e.length-4)),this._deflate[K]=null,this._deflate[Y]=0,this._deflate[Q]=[],t&&this.params[`${n}_no_context_takeover`]&&this._deflate.reset(),r(null,e)}))}};function ee(e){this[Q].push(e),this[Y]+=e.length}function te(e){this[Y]+=e.length,this[G]._maxPayload<1||this[Y]<=this[G]._maxPayload?this[Q].push(e):(this[J]=new RangeError("Max payload size exceeded"),this[J].code="WS_ERR_UNSUPPORTED_MESSAGE_LENGTH",this[J][z]=1009,this.removeListener("data",te),this.reset())}function re(e){this[G]._inflate=null,e[z]=1007,this[K](e)}var ne={exports:{}};const{isUtf8:oe}=i;function se(e){const t=e.length;let r=0;for(;r<t;)if(0==(128&e[r]))r++;else if(192==(224&e[r])){if(r+1===t||128!=(192&e[r+1])||192==(254&e[r]))return!1;r+=2}else if(224==(240&e[r])){if(r+2>=t||128!=(192&e[r+1])||128!=(192&e[r+2])||224===e[r]&&128==(224&e[r+1])||237===e[r]&&160==(224&e[r+1]))return!1;r+=3}else{if(240!=(248&e[r]))return!1;if(r+3>=t||128!=(192&e[r+1])||128!=(192&e[r+2])||128!=(192&e[r+3])||240===e[r]&&128==(240&e[r+1])||244===e[r]&&e[r+1]>143||e[r]>244)return!1;r+=4}return!0}if(ne.exports={isValidStatusCode:function(e){return e>=1e3&&e<=1014&&1004!==e&&1005!==e&&1006!==e||e>=3e3&&e<=4999},isValidUTF8:se,tokenChars:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0]},oe)ne.exports.isValidUTF8=function(e){return e.length<24?se(e):oe(e)};else if(!process.env.WS_NO_UTF_8_VALIDATE)try{const e=require("utf-8-validate");ne.exports.isValidUTF8=function(t){return t.length<32?se(t):e(t)}}catch(Hr){}var ie=ne.exports;const{Writable:ae}=e,le=Z,{BINARY_TYPES:ce,EMPTY_BUFFER:ue,kStatusCode:de,kWebSocket:he}=D,{concat:fe,toArrayBuffer:pe,unmask:me}=j,{isValidStatusCode:_e,isValidUTF8:ge}=ie,be=Buffer[Symbol.species],ye=Promise.resolve(),we="function"==typeof queueMicrotask?queueMicrotask:function(e){ye.then(e).catch(Ee)};var ve=class extends ae{constructor(e={}){super(),this._allowSynchronousEvents=!!e.allowSynchronousEvents,this._binaryType=e.binaryType||ce[0],this._extensions=e.extensions||{},this._isServer=!!e.isServer,this._maxPayload=0|e.maxPayload,this._skipUTF8Validation=!!e.skipUTF8Validation,this[he]=void 0,this._bufferedBytes=0,this._buffers=[],this._compressed=!1,this._payloadLength=0,this._mask=void 0,this._fragmented=0,this._masked=!1,this._fin=!1,this._opcode=0,this._totalPayloadLength=0,this._messageLength=0,this._fragments=[],this._errored=!1,this._loop=!1,this._state=0}_write(e,t,r){if(8===this._opcode&&0==this._state)return r();this._bufferedBytes+=e.length,this._buffers.push(e),this.startLoop(r)}consume(e){if(this._bufferedBytes-=e,e===this._buffers[0].length)return this._buffers.shift();if(e<this._buffers[0].length){const t=this._buffers[0];return this._buffers[0]=new be(t.buffer,t.byteOffset+e,t.length-e),new be(t.buffer,t.byteOffset,e)}const t=Buffer.allocUnsafe(e);do{const r=this._buffers[0],n=t.length-e;e>=r.length?t.set(this._buffers.shift(),n):(t.set(new Uint8Array(r.buffer,r.byteOffset,e),n),this._buffers[0]=new be(r.buffer,r.byteOffset+e,r.length-e)),e-=r.length}while(e>0);return t}startLoop(e){this._loop=!0;do{switch(this._state){case 0:this.getInfo(e);break;case 1:this.getPayloadLength16(e);break;case 2:this.getPayloadLength64(e);break;case 3:this.getMask();break;case 4:this.getData(e);break;case 5:case 6:return void(this._loop=!1)}}while(this._loop);this._errored||e()}getInfo(e){if(this._bufferedBytes<2)return void(this._loop=!1);const t=this.consume(2);if(0!=(48&t[0])){return void e(this.createError(RangeError,"RSV2 and RSV3 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_2_3"))}const r=64==(64&t[0]);if(!r||this._extensions[le.extensionName]){if(this._fin=128==(128&t[0]),this._opcode=15&t[0],this._payloadLength=127&t[1],0===this._opcode){if(r){return void e(this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1"))}if(!this._fragmented){return void e(this.createError(RangeError,"invalid opcode 0",!0,1002,"WS_ERR_INVALID_OPCODE"))}this._opcode=this._fragmented}else if(1===this._opcode||2===this._opcode){if(this._fragmented){return void e(this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE"))}this._compressed=r}else{if(!(this._opcode>7&&this._opcode<11)){return void e(this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE"))}if(!this._fin){return void e(this.createError(RangeError,"FIN must be set",!0,1002,"WS_ERR_EXPECTED_FIN"))}if(r){return void e(this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1"))}if(this._payloadLength>125||8===this._opcode&&1===this._payloadLength){return void e(this.createError(RangeError,`invalid payload length ${this._payloadLength}`,!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH"))}}if(this._fin||this._fragmented||(this._fragmented=this._opcode),this._masked=128==(128&t[1]),this._isServer){if(!this._masked){return void e(this.createError(RangeError,"MASK must be set",!0,1002,"WS_ERR_EXPECTED_MASK"))}}else if(this._masked){return void e(this.createError(RangeError,"MASK must be clear",!0,1002,"WS_ERR_UNEXPECTED_MASK"))}126===this._payloadLength?this._state=1:127===this._payloadLength?this._state=2:this.haveLength(e)}else{e(this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1"))}}getPayloadLength16(e){this._bufferedBytes<2?this._loop=!1:(this._payloadLength=this.consume(2).readUInt16BE(0),this.haveLength(e))}getPayloadLength64(e){if(this._bufferedBytes<8)return void(this._loop=!1);const t=this.consume(8),r=t.readUInt32BE(0);if(r>Math.pow(2,21)-1){e(this.createError(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",!1,1009,"WS_ERR_UNSUPPORTED_DATA_PAYLOAD_LENGTH"))}else this._payloadLength=r*Math.pow(2,32)+t.readUInt32BE(4),this.haveLength(e)}haveLength(e){if(this._payloadLength&&this._opcode<8&&(this._totalPayloadLength+=this._payloadLength,this._totalPayloadLength>this._maxPayload&&this._maxPayload>0)){e(this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH"))}else this._masked?this._state=3:this._state=4}getMask(){this._bufferedBytes<4?this._loop=!1:(this._mask=this.consume(4),this._state=4)}getData(e){let t=ue;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength)return void(this._loop=!1);t=this.consume(this._payloadLength),this._masked&&0!=(this._mask[0]|this._mask[1]|this._mask[2]|this._mask[3])&&me(t,this._mask)}if(this._opcode>7)this.controlMessage(t,e);else{if(this._compressed)return this._state=5,void this.decompress(t,e);t.length&&(this._messageLength=this._totalPayloadLength,this._fragments.push(t)),this.dataMessage(e)}}decompress(e,t){this._extensions[le.extensionName].decompress(e,this._fin,((e,r)=>{if(e)return t(e);if(r.length){if(this._messageLength+=r.length,this._messageLength>this._maxPayload&&this._maxPayload>0){const e=this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");return void t(e)}this._fragments.push(r)}this.dataMessage(t),0===this._state&&this.startLoop(t)}))}dataMessage(e){if(!this._fin)return void(this._state=0);const t=this._messageLength,r=this._fragments;if(this._totalPayloadLength=0,this._messageLength=0,this._fragmented=0,this._fragments=[],2===this._opcode){let n;n="nodebuffer"===this._binaryType?fe(r,t):"arraybuffer"===this._binaryType?pe(fe(r,t)):r,5===this._state||this._allowSynchronousEvents?(this.emit("message",n,!0),this._state=0):(this._state=6,we((()=>{this.emit("message",n,!0),this._state=0,this.startLoop(e)})))}else{const n=fe(r,t);if(!this._skipUTF8Validation&&!ge(n)){const t=this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");return void e(t)}5===this._state||this._allowSynchronousEvents?(this.emit("message",n,!1),this._state=0):(this._state=6,we((()=>{this.emit("message",n,!1),this._state=0,this.startLoop(e)})))}}controlMessage(e,t){if(8!==this._opcode)this._allowSynchronousEvents?(this.emit(9===this._opcode?"ping":"pong",e),this._state=0):(this._state=6,we((()=>{this.emit(9===this._opcode?"ping":"pong",e),this._state=0,this.startLoop(t)})));else{if(0===e.length)this._loop=!1,this.emit("conclude",1005,ue),this.end();else{const r=e.readUInt16BE(0);if(!_e(r)){const e=this.createError(RangeError,`invalid status code ${r}`,!0,1002,"WS_ERR_INVALID_CLOSE_CODE");return void t(e)}const n=new be(e.buffer,e.byteOffset+2,e.length-2);if(!this._skipUTF8Validation&&!ge(n)){const e=this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");return void t(e)}this._loop=!1,this.emit("conclude",r,n),this.end()}this._state=0}}createError(e,t,r,n,o){this._loop=!1,this._errored=!0;const s=new e(r?`Invalid WebSocket frame: ${t}`:t);return Error.captureStackTrace(s,this.createError),s.code=o,s[de]=n,s}};function Se(e){throw e}function Ee(e){process.nextTick(Se,e)}const{randomFillSync:Te}=n,Re=Z,{EMPTY_BUFFER:ke}=D,{isValidStatusCode:Pe}=ie,{mask:Ce,toBuffer:Oe}=j,xe=Symbol("kByteLength"),Ae=Buffer.alloc(4);var Le=class e{constructor(e,t,r){this._extensions=t||{},r&&(this._generateMask=r,this._maskBuffer=Buffer.alloc(4)),this._socket=e,this._firstFragment=!0,this._compress=!1,this._bufferedBytes=0,this._deflating=!1,this._queue=[]}static frame(e,t){let r,n,o=!1,s=2,i=!1;t.mask&&(r=t.maskBuffer||Ae,t.generateMask?t.generateMask(r):Te(r,0,4),i=0==(r[0]|r[1]|r[2]|r[3]),s=6),"string"==typeof e?n=t.mask&&!i||void 0===t[xe]?(e=Buffer.from(e)).length:t[xe]:(n=e.length,o=t.mask&&t.readOnly&&!i);let a=n;n>=65536?(s+=8,a=127):n>125&&(s+=2,a=126);const l=Buffer.allocUnsafe(o?n+s:s);return l[0]=t.fin?128|t.opcode:t.opcode,t.rsv1&&(l[0]|=64),l[1]=a,126===a?l.writeUInt16BE(n,2):127===a&&(l[2]=l[3]=0,l.writeUIntBE(n,4,6)),t.mask?(l[1]|=128,l[s-4]=r[0],l[s-3]=r[1],l[s-2]=r[2],l[s-1]=r[3],i?[l,e]:o?(Ce(e,r,l,s,n),[l]):(Ce(e,r,e,0,n),[l,e])):[l,e]}close(t,r,n,o){let s;if(void 0===t)s=ke;else{if("number"!=typeof t||!Pe(t))throw new TypeError("First argument must be a valid error code number");if(void 0!==r&&r.length){const e=Buffer.byteLength(r);if(e>123)throw new RangeError("The message must not be greater than 123 bytes");s=Buffer.allocUnsafe(2+e),s.writeUInt16BE(t,0),"string"==typeof r?s.write(r,2):s.set(r,2)}else s=Buffer.allocUnsafe(2),s.writeUInt16BE(t,0)}const i={[xe]:s.length,fin:!0,generateMask:this._generateMask,mask:n,maskBuffer:this._maskBuffer,opcode:8,readOnly:!1,rsv1:!1};this._deflating?this.enqueue([this.dispatch,s,!1,i,o]):this.sendFrame(e.frame(s,i),o)}ping(t,r,n){let o,s;if("string"==typeof t?(o=Buffer.byteLength(t),s=!1):(o=(t=Oe(t)).length,s=Oe.readOnly),o>125)throw new RangeError("The data size must not be greater than 125 bytes");const i={[xe]:o,fin:!0,generateMask:this._generateMask,mask:r,maskBuffer:this._maskBuffer,opcode:9,readOnly:s,rsv1:!1};this._deflating?this.enqueue([this.dispatch,t,!1,i,n]):this.sendFrame(e.frame(t,i),n)}pong(t,r,n){let o,s;if("string"==typeof t?(o=Buffer.byteLength(t),s=!1):(o=(t=Oe(t)).length,s=Oe.readOnly),o>125)throw new RangeError("The data size must not be greater than 125 bytes");const i={[xe]:o,fin:!0,generateMask:this._generateMask,mask:r,maskBuffer:this._maskBuffer,opcode:10,readOnly:s,rsv1:!1};this._deflating?this.enqueue([this.dispatch,t,!1,i,n]):this.sendFrame(e.frame(t,i),n)}send(t,r,n){const o=this._extensions[Re.extensionName];let s,i,a=r.binary?2:1,l=r.compress;if("string"==typeof t?(s=Buffer.byteLength(t),i=!1):(s=(t=Oe(t)).length,i=Oe.readOnly),this._firstFragment?(this._firstFragment=!1,l&&o&&o.params[o._isServer?"server_no_context_takeover":"client_no_context_takeover"]&&(l=s>=o._threshold),this._compress=l):(l=!1,a=0),r.fin&&(this._firstFragment=!0),o){const e={[xe]:s,fin:r.fin,generateMask:this._generateMask,mask:r.mask,maskBuffer:this._maskBuffer,opcode:a,readOnly:i,rsv1:l};this._deflating?this.enqueue([this.dispatch,t,this._compress,e,n]):this.dispatch(t,this._compress,e,n)}else this.sendFrame(e.frame(t,{[xe]:s,fin:r.fin,generateMask:this._generateMask,mask:r.mask,maskBuffer:this._maskBuffer,opcode:a,readOnly:i,rsv1:!1}),n)}dispatch(t,r,n,o){if(!r)return void this.sendFrame(e.frame(t,n),o);const s=this._extensions[Re.extensionName];this._bufferedBytes+=n[xe],this._deflating=!0,s.compress(t,n.fin,((t,r)=>{if(this._socket.destroyed){const e=new Error("The socket was closed while data was being compressed");"function"==typeof o&&o(e);for(let t=0;t<this._queue.length;t++){const r=this._queue[t],n=r[r.length-1];"function"==typeof n&&n(e)}}else this._bufferedBytes-=n[xe],this._deflating=!1,n.readOnly=!1,this.sendFrame(e.frame(r,n),o),this.dequeue()}))}dequeue(){for(;!this._deflating&&this._queue.length;){const e=this._queue.shift();this._bufferedBytes-=e[3][xe],Reflect.apply(e[0],this,e.slice(1))}}enqueue(e){this._bufferedBytes+=e[3][xe],this._queue.push(e)}sendFrame(e,t){2===e.length?(this._socket.cork(),this._socket.write(e[0]),this._socket.write(e[1],t),this._socket.uncork()):this._socket.write(e[0],t)}};const{kForOnEventAttribute:De,kListener:Ie}=D,Be=Symbol("kCode"),$e=Symbol("kData"),Ue=Symbol("kError"),je=Symbol("kMessage"),qe=Symbol("kReason"),Ne=Symbol("kTarget"),Fe=Symbol("kType"),We=Symbol("kWasClean");let Me=class{constructor(e){this[Ne]=null,this[Fe]=e}get target(){return this[Ne]}get type(){return this[Fe]}};Object.defineProperty(Me.prototype,"target",{enumerable:!0}),Object.defineProperty(Me.prototype,"type",{enumerable:!0});class ze extends Me{constructor(e,t={}){super(e),this[Be]=void 0===t.code?0:t.code,this[qe]=void 0===t.reason?"":t.reason,this[We]=void 0!==t.wasClean&&t.wasClean}get code(){return this[Be]}get reason(){return this[qe]}get wasClean(){return this[We]}}Object.defineProperty(ze.prototype,"code",{enumerable:!0}),Object.defineProperty(ze.prototype,"reason",{enumerable:!0}),Object.defineProperty(ze.prototype,"wasClean",{enumerable:!0});class He extends Me{constructor(e,t={}){super(e),this[Ue]=void 0===t.error?null:t.error,this[je]=void 0===t.message?"":t.message}get error(){return this[Ue]}get message(){return this[je]}}Object.defineProperty(He.prototype,"error",{enumerable:!0}),Object.defineProperty(He.prototype,"message",{enumerable:!0});class Ve extends Me{constructor(e,t={}){super(e),this[$e]=void 0===t.data?null:t.data}get data(){return this[$e]}}Object.defineProperty(Ve.prototype,"data",{enumerable:!0});const Ge={addEventListener(e,t,r={}){for(const n of this.listeners(e))if(!r[De]&&n[Ie]===t&&!n[De])return;let n;if("message"===e)n=function(e,r){const n=new Ve("message",{data:r?e:e.toString()});n[Ne]=this,Ke(t,this,n)};else if("close"===e)n=function(e,r){const n=new ze("close",{code:e,reason:r.toString(),wasClean:this._closeFrameReceived&&this._closeFrameSent});n[Ne]=this,Ke(t,this,n)};else if("error"===e)n=function(e){const r=new He("error",{error:e,message:e.message});r[Ne]=this,Ke(t,this,r)};else{if("open"!==e)return;n=function(){const e=new Me("open");e[Ne]=this,Ke(t,this,e)}}n[De]=!!r[De],n[Ie]=t,r.once?this.once(e,n):this.on(e,n)},removeEventListener(e,t){for(const r of this.listeners(e))if(r[Ie]===t&&!r[De]){this.removeListener(e,r);break}}};var Ye={CloseEvent:ze,ErrorEvent:He,Event:Me,EventTarget:Ge,MessageEvent:Ve};function Ke(e,t,r){"object"==typeof e&&e.handleEvent?e.handleEvent.call(e,r):e.call(t,r)}const{tokenChars:Qe}=ie;function Je(e,t,r){void 0===e[t]?e[t]=[r]:e[t].push(r)}var Xe={format:function(e){return Object.keys(e).map((t=>{let r=e[t];return Array.isArray(r)||(r=[r]),r.map((e=>[t].concat(Object.keys(e).map((t=>{let r=e[t];return Array.isArray(r)||(r=[r]),r.map((e=>!0===e?t:`${t}=${e}`)).join("; ")}))).join("; "))).join(", ")})).join(", ")},parse:function(e){const t=Object.create(null);let r,n,o=Object.create(null),s=!1,i=!1,a=!1,l=-1,c=-1,u=-1,d=0;for(;d<e.length;d++)if(c=e.charCodeAt(d),void 0===r)if(-1===u&&1===Qe[c])-1===l&&(l=d);else if(0===d||32!==c&&9!==c){if(59!==c&&44!==c)throw new SyntaxError(`Unexpected character at index ${d}`);{if(-1===l)throw new SyntaxError(`Unexpected character at index ${d}`);-1===u&&(u=d);const n=e.slice(l,u);44===c?(Je(t,n,o),o=Object.create(null)):r=n,l=u=-1}}else-1===u&&-1!==l&&(u=d);else if(void 0===n)if(-1===u&&1===Qe[c])-1===l&&(l=d);else if(32===c||9===c)-1===u&&-1!==l&&(u=d);else if(59===c||44===c){if(-1===l)throw new SyntaxError(`Unexpected character at index ${d}`);-1===u&&(u=d),Je(o,e.slice(l,u),!0),44===c&&(Je(t,r,o),o=Object.create(null),r=void 0),l=u=-1}else{if(61!==c||-1===l||-1!==u)throw new SyntaxError(`Unexpected character at index ${d}`);n=e.slice(l,d),l=u=-1}else if(i){if(1!==Qe[c])throw new SyntaxError(`Unexpected character at index ${d}`);-1===l?l=d:s||(s=!0),i=!1}else if(a)if(1===Qe[c])-1===l&&(l=d);else if(34===c&&-1!==l)a=!1,u=d;else{if(92!==c)throw new SyntaxError(`Unexpected character at index ${d}`);i=!0}else if(34===c&&61===e.charCodeAt(d-1))a=!0;else if(-1===u&&1===Qe[c])-1===l&&(l=d);else if(-1===l||32!==c&&9!==c){if(59!==c&&44!==c)throw new SyntaxError(`Unexpected character at index ${d}`);{if(-1===l)throw new SyntaxError(`Unexpected character at index ${d}`);-1===u&&(u=d);let i=e.slice(l,u);s&&(i=i.replace(/\\/g,""),s=!1),Je(o,n,i),44===c&&(Je(t,r,o),o=Object.create(null),r=void 0),n=void 0,l=u=-1}}else-1===u&&(u=d);if(-1===l||a||32===c||9===c)throw new SyntaxError("Unexpected end of input");-1===u&&(u=d);const h=e.slice(l,u);return void 0===r?Je(t,h,o):(void 0===n?Je(o,h,!0):Je(o,n,s?h.replace(/\\/g,""):h),Je(t,r,o)),t}};const Ze=t,et=a,tt=r,rt=l,nt=c,{randomBytes:ot,createHash:st}=n,{URL:it}=u,at=Z,lt=ve,ct=Le,{BINARY_TYPES:ut,EMPTY_BUFFER:dt,GUID:ht,kForOnEventAttribute:ft,kListener:pt,kStatusCode:mt,kWebSocket:_t,NOOP:gt}=D,{EventTarget:{addEventListener:bt,removeEventListener:yt}}=Ye,{format:wt,parse:vt}=Xe,{toBuffer:St}=j,Et=Symbol("kAborted"),Tt=[8,13],Rt=["CONNECTING","OPEN","CLOSING","CLOSED"],kt=/^[!#$%&'*+\-.0-9A-Z^_`|a-z~]+$/;class Pt extends Ze{constructor(e,t,r){super(),this._binaryType=ut[0],this._closeCode=1006,this._closeFrameReceived=!1,this._closeFrameSent=!1,this._closeMessage=dt,this._closeTimer=null,this._extensions={},this._paused=!1,this._protocol="",this._readyState=Pt.CONNECTING,this._receiver=null,this._sender=null,this._socket=null,null!==e?(this._bufferedAmount=0,this._isServer=!1,this._redirects=0,void 0===t?t=[]:Array.isArray(t)||("object"==typeof t&&null!==t?(r=t,t=[]):t=[t]),Ct(this,e,t,r)):this._isServer=!0}get binaryType(){return this._binaryType}set binaryType(e){ut.includes(e)&&(this._binaryType=e,this._receiver&&(this._receiver._binaryType=e))}get bufferedAmount(){return this._socket?this._socket._writableState.length+this._sender._bufferedBytes:this._bufferedAmount}get extensions(){return Object.keys(this._extensions).join()}get isPaused(){return this._paused}get onclose(){return null}get onerror(){return null}get onopen(){return null}get onmessage(){return null}get protocol(){return this._protocol}get readyState(){return this._readyState}get url(){return this._url}setSocket(e,t,r){const n=new lt({allowSynchronousEvents:r.allowSynchronousEvents,binaryType:this.binaryType,extensions:this._extensions,isServer:this._isServer,maxPayload:r.maxPayload,skipUTF8Validation:r.skipUTF8Validation});this._sender=new ct(e,this._extensions,r.generateMask),this._receiver=n,this._socket=e,n[_t]=this,e[_t]=this,n.on("conclude",It),n.on("drain",Bt),n.on("error",$t),n.on("message",jt),n.on("ping",qt),n.on("pong",Nt),e.setTimeout&&e.setTimeout(0),e.setNoDelay&&e.setNoDelay(),t.length>0&&e.unshift(t),e.on("close",Wt),e.on("data",Mt),e.on("end",zt),e.on("error",Ht),this._readyState=Pt.OPEN,this.emit("open")}emitClose(){if(!this._socket)return this._readyState=Pt.CLOSED,void this.emit("close",this._closeCode,this._closeMessage);this._extensions[at.extensionName]&&this._extensions[at.extensionName].cleanup(),this._receiver.removeAllListeners(),this._readyState=Pt.CLOSED,this.emit("close",this._closeCode,this._closeMessage)}close(e,t){if(this.readyState!==Pt.CLOSED)if(this.readyState!==Pt.CONNECTING)this.readyState!==Pt.CLOSING?(this._readyState=Pt.CLOSING,this._sender.close(e,t,!this._isServer,(e=>{e||(this._closeFrameSent=!0,(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end())})),this._closeTimer=setTimeout(this._socket.destroy.bind(this._socket),3e4)):this._closeFrameSent&&(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end();else{const e="WebSocket was closed before the connection was established";Lt(this,this._req,e)}}pause(){this.readyState!==Pt.CONNECTING&&this.readyState!==Pt.CLOSED&&(this._paused=!0,this._socket.pause())}ping(e,t,r){if(this.readyState===Pt.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");"function"==typeof e?(r=e,e=t=void 0):"function"==typeof t&&(r=t,t=void 0),"number"==typeof e&&(e=e.toString()),this.readyState===Pt.OPEN?(void 0===t&&(t=!this._isServer),this._sender.ping(e||dt,t,r)):Dt(this,e,r)}pong(e,t,r){if(this.readyState===Pt.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");"function"==typeof e?(r=e,e=t=void 0):"function"==typeof t&&(r=t,t=void 0),"number"==typeof e&&(e=e.toString()),this.readyState===Pt.OPEN?(void 0===t&&(t=!this._isServer),this._sender.pong(e||dt,t,r)):Dt(this,e,r)}resume(){this.readyState!==Pt.CONNECTING&&this.readyState!==Pt.CLOSED&&(this._paused=!1,this._receiver._writableState.needDrain||this._socket.resume())}send(e,t,r){if(this.readyState===Pt.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if("function"==typeof t&&(r=t,t={}),"number"==typeof e&&(e=e.toString()),this.readyState!==Pt.OPEN)return void Dt(this,e,r);const n={binary:"string"!=typeof e,mask:!this._isServer,compress:!0,fin:!0,...t};this._extensions[at.extensionName]||(n.compress=!1),this._sender.send(e||dt,n,r)}terminate(){if(this.readyState!==Pt.CLOSED)if(this.readyState!==Pt.CONNECTING)this._socket&&(this._readyState=Pt.CLOSING,this._socket.destroy());else{const e="WebSocket was closed before the connection was established";Lt(this,this._req,e)}}}function Ct(e,t,r,n){const o={allowSynchronousEvents:!1,protocolVersion:Tt[1],maxPayload:104857600,skipUTF8Validation:!1,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10,...n,createConnection:void 0,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:"GET",host:void 0,path:void 0,port:void 0};if(!Tt.includes(o.protocolVersion))throw new RangeError(`Unsupported protocol version: ${o.protocolVersion} (supported versions: ${Tt.join(", ")})`);let s;if(t instanceof it)s=t;else try{s=new it(t)}catch(e){throw new SyntaxError(`Invalid URL: ${t}`)}"http:"===s.protocol?s.protocol="ws:":"https:"===s.protocol&&(s.protocol="wss:"),e._url=s.href;const i="wss:"===s.protocol,a="ws+unix:"===s.protocol;let l;if("ws:"===s.protocol||i||a?a&&!s.pathname?l="The URL's pathname is empty":s.hash&&(l="The URL contains a fragment identifier"):l='The URL\'s protocol must be one of "ws:", "wss:", "http:", "https", or "ws+unix:"',l){const t=new SyntaxError(l);if(0===e._redirects)throw t;return void Ot(e,t)}const c=i?443:80,u=ot(16).toString("base64"),d=i?et.request:tt.request,h=new Set;let f,p;if(o.createConnection=i?At:xt,o.defaultPort=o.defaultPort||c,o.port=s.port||c,o.host=s.hostname.startsWith("[")?s.hostname.slice(1,-1):s.hostname,o.headers={...o.headers,"Sec-WebSocket-Version":o.protocolVersion,"Sec-WebSocket-Key":u,Connection:"Upgrade",Upgrade:"websocket"},o.path=s.pathname+s.search,o.timeout=o.handshakeTimeout,o.perMessageDeflate&&(f=new at(!0!==o.perMessageDeflate?o.perMessageDeflate:{},!1,o.maxPayload),o.headers["Sec-WebSocket-Extensions"]=wt({[at.extensionName]:f.offer()})),r.length){for(const e of r){if("string"!=typeof e||!kt.test(e)||h.has(e))throw new SyntaxError("An invalid or duplicated subprotocol was specified");h.add(e)}o.headers["Sec-WebSocket-Protocol"]=r.join(",")}if(o.origin&&(o.protocolVersion<13?o.headers["Sec-WebSocket-Origin"]=o.origin:o.headers.Origin=o.origin),(s.username||s.password)&&(o.auth=`${s.username}:${s.password}`),a){const e=o.path.split(":");o.socketPath=e[0],o.path=e[1]}if(o.followRedirects){if(0===e._redirects){e._originalIpc=a,e._originalSecure=i,e._originalHostOrSocketPath=a?o.socketPath:s.host;const t=n&&n.headers;if(n={...n,headers:{}},t)for(const[e,r]of Object.entries(t))n.headers[e.toLowerCase()]=r}else if(0===e.listenerCount("redirect")){const t=a?!!e._originalIpc&&o.socketPath===e._originalHostOrSocketPath:!e._originalIpc&&s.host===e._originalHostOrSocketPath;(!t||e._originalSecure&&!i)&&(delete o.headers.authorization,delete o.headers.cookie,t||delete o.headers.host,o.auth=void 0)}o.auth&&!n.headers.authorization&&(n.headers.authorization="Basic "+Buffer.from(o.auth).toString("base64")),p=e._req=d(o),e._redirects&&e.emit("redirect",e.url,p)}else p=e._req=d(o);o.timeout&&p.on("timeout",(()=>{Lt(e,p,"Opening handshake has timed out")})),p.on("error",(t=>{null===p||p[Et]||(p=e._req=null,Ot(e,t))})),p.on("response",(s=>{const i=s.headers.location,a=s.statusCode;if(i&&o.followRedirects&&a>=300&&a<400){if(++e._redirects>o.maxRedirects)return void Lt(e,p,"Maximum redirects exceeded");let s;p.abort();try{s=new it(i,t)}catch(t){const r=new SyntaxError(`Invalid URL: ${i}`);return void Ot(e,r)}Ct(e,s,r,n)}else e.emit("unexpected-response",p,s)||Lt(e,p,`Unexpected server response: ${s.statusCode}`)})),p.on("upgrade",((t,r,n)=>{if(e.emit("upgrade",t),e.readyState!==Pt.CONNECTING)return;if(p=e._req=null,"websocket"!==t.headers.upgrade.toLowerCase())return void Lt(e,r,"Invalid Upgrade header");const s=st("sha1").update(u+ht).digest("base64");if(t.headers["sec-websocket-accept"]!==s)return void Lt(e,r,"Invalid Sec-WebSocket-Accept header");const i=t.headers["sec-websocket-protocol"];let a;if(void 0!==i?h.size?h.has(i)||(a="Server sent an invalid subprotocol"):a="Server sent a subprotocol but none was requested":h.size&&(a="Server sent no subprotocol"),a)return void Lt(e,r,a);i&&(e._protocol=i);const l=t.headers["sec-websocket-extensions"];if(void 0!==l){if(!f){return void Lt(e,r,"Server sent a Sec-WebSocket-Extensions header but no extension was requested")}let t;try{t=vt(l)}catch(t){return void Lt(e,r,"Invalid Sec-WebSocket-Extensions header")}const n=Object.keys(t);if(1!==n.length||n[0]!==at.extensionName){return void Lt(e,r,"Server indicated an extension that was not requested")}try{f.accept(t[at.extensionName])}catch(t){return void Lt(e,r,"Invalid Sec-WebSocket-Extensions header")}e._extensions[at.extensionName]=f}e.setSocket(r,n,{allowSynchronousEvents:o.allowSynchronousEvents,generateMask:o.generateMask,maxPayload:o.maxPayload,skipUTF8Validation:o.skipUTF8Validation})})),o.finishRequest?o.finishRequest(p,e):p.end()}function Ot(e,t){e._readyState=Pt.CLOSING,e.emit("error",t),e.emitClose()}function xt(e){return e.path=e.socketPath,rt.connect(e)}function At(e){return e.path=void 0,e.servername||""===e.servername||(e.servername=rt.isIP(e.host)?"":e.host),nt.connect(e)}function Lt(e,t,r){e._readyState=Pt.CLOSING;const n=new Error(r);Error.captureStackTrace(n,Lt),t.setHeader?(t[Et]=!0,t.abort(),t.socket&&!t.socket.destroyed&&t.socket.destroy(),process.nextTick(Ot,e,n)):(t.destroy(n),t.once("error",e.emit.bind(e,"error")),t.once("close",e.emitClose.bind(e)))}function Dt(e,t,r){if(t){const r=St(t).length;e._socket?e._sender._bufferedBytes+=r:e._bufferedAmount+=r}if(r){const t=new Error(`WebSocket is not open: readyState ${e.readyState} (${Rt[e.readyState]})`);process.nextTick(r,t)}}function It(e,t){const r=this[_t];r._closeFrameReceived=!0,r._closeMessage=t,r._closeCode=e,void 0!==r._socket[_t]&&(r._socket.removeListener("data",Mt),process.nextTick(Ft,r._socket),1005===e?r.close():r.close(e,t))}function Bt(){const e=this[_t];e.isPaused||e._socket.resume()}function $t(e){const t=this[_t];void 0!==t._socket[_t]&&(t._socket.removeListener("data",Mt),process.nextTick(Ft,t._socket),t.close(e[mt])),t.emit("error",e)}function Ut(){this[_t].emitClose()}function jt(e,t){this[_t].emit("message",e,t)}function qt(e){const t=this[_t];t.pong(e,!t._isServer,gt),t.emit("ping",e)}function Nt(e){this[_t].emit("pong",e)}function Ft(e){e.resume()}function Wt(){const e=this[_t];let t;this.removeListener("close",Wt),this.removeListener("data",Mt),this.removeListener("end",zt),e._readyState=Pt.CLOSING,this._readableState.endEmitted||e._closeFrameReceived||e._receiver._writableState.errorEmitted||null===(t=e._socket.read())||e._receiver.write(t),e._receiver.end(),this[_t]=void 0,clearTimeout(e._closeTimer),e._receiver._writableState.finished||e._receiver._writableState.errorEmitted?e.emitClose():(e._receiver.on("error",Ut),e._receiver.on("finish",Ut))}function Mt(e){this[_t]._receiver.write(e)||this.pause()}function zt(){const e=this[_t];e._readyState=Pt.CLOSING,e._receiver.end(),this.end()}function Ht(){const e=this[_t];this.removeListener("error",Ht),this.on("error",gt),e&&(e._readyState=Pt.CLOSING,this.destroy())}Object.defineProperty(Pt,"CONNECTING",{enumerable:!0,value:Rt.indexOf("CONNECTING")}),Object.defineProperty(Pt.prototype,"CONNECTING",{enumerable:!0,value:Rt.indexOf("CONNECTING")}),Object.defineProperty(Pt,"OPEN",{enumerable:!0,value:Rt.indexOf("OPEN")}),Object.defineProperty(Pt.prototype,"OPEN",{enumerable:!0,value:Rt.indexOf("OPEN")}),Object.defineProperty(Pt,"CLOSING",{enumerable:!0,value:Rt.indexOf("CLOSING")}),Object.defineProperty(Pt.prototype,"CLOSING",{enumerable:!0,value:Rt.indexOf("CLOSING")}),Object.defineProperty(Pt,"CLOSED",{enumerable:!0,value:Rt.indexOf("CLOSED")}),Object.defineProperty(Pt.prototype,"CLOSED",{enumerable:!0,value:Rt.indexOf("CLOSED")}),["binaryType","bufferedAmount","extensions","isPaused","protocol","readyState","url"].forEach((e=>{Object.defineProperty(Pt.prototype,e,{enumerable:!0})})),["open","error","close","message"].forEach((e=>{Object.defineProperty(Pt.prototype,`on${e}`,{enumerable:!0,get(){for(const t of this.listeners(e))if(t[ft])return t[pt];return null},set(t){for(const t of this.listeners(e))if(t[ft]){this.removeListener(e,t);break}"function"==typeof t&&this.addEventListener(e,t,{[ft]:!0})}})})),Pt.prototype.addEventListener=bt,Pt.prototype.removeEventListener=yt;var Vt=A(Pt);
/**!
 * @author Elgato
 * @module elgato/streamdeck
 * @license MIT
 * @copyright Copyright (c) Corsair Memory Inc.
 */class Gt{type;constructor(e){this.type=e.event}}class Yt extends Gt{action;deviceId;constructor(e,t){super(t),this.action=e,this.deviceId=t.device}}class Kt extends Yt{payload;constructor(e,t){super(e,t),this.payload=t.payload}}class Qt extends Gt{application;constructor(e){super(e),this.application=e.payload.application}}class Jt extends Gt{device;constructor(e,t){super(e),this.device=t}}class Xt extends Gt{url;constructor(e){super(e),this.url=new er(e.payload.url)}}const Zt="streamdeck://";class er{fragment;href;path;query;queryParameters;constructor(e){const t=new URL(`${Zt}${e}`);this.fragment=t.hash.substring(1),this.href=t.href.substring(13),this.path=er.parsePath(this.href),this.query=t.search.substring(1),this.queryParameters=t.searchParams}static parsePath(e){const t=t=>{const r=e.indexOf(t);return r>=0?r:e.length};return e.substring(0,Math.min(t("?"),t("#")))}}class tr extends Gt{action;payload;constructor(e,t){super(t),this.action=e,this.payload=t.payload}}class rr extends Gt{settings;constructor(e){super(e),this.settings=e.payload.settings}}class nr{connection;id;manifestId;constructor(e,t){this.connection=e,this.id=t.context,this.manifestId=t.action}getSettings(){return e=this.connection,t=this.id,new Promise((r=>{const n=o=>{o.context==t&&(r(o.payload.settings),e.removeListener("didReceiveSettings",n))};e.on("didReceiveSettings",n),e.send({event:"getSettings",context:t})}));var e,t}sendToPropertyInspector(e){return this.connection.send({event:"sendToPropertyInspector",context:this.id,payload:e})}setFeedback(e){return this.connection.send({event:"setFeedback",context:this.id,payload:e})}setFeedbackLayout(e){return this.connection.send({event:"setFeedbackLayout",context:this.id,payload:{layout:e}})}setImage(e,t){return this.connection.send({event:"setImage",context:this.id,payload:{image:e,...t}})}setSettings(e){return this.connection.send({event:"setSettings",context:this.id,payload:e})}setState(e){return this.connection.send({event:"setState",context:this.id,payload:{state:e}})}setTitle(e,t){return this.connection.send({event:"setTitle",context:this.id,payload:{title:e,...t}})}setTriggerDescription(e){return this.connection.send({event:"setTriggerDescription",context:this.id,payload:e||{}})}showAlert(){return this.connection.send({event:"showAlert",context:this.id})}showOk(){return this.connection.send({event:"showOk",context:this.id})}}class or{connection;manifest;settingsClient;uiClient;logger;constructor(e,t,r,n,o){this.connection=e,this.manifest=t,this.settingsClient=r,this.uiClient=n,this.logger=o.createScope("ActionClient")}createController(e){return new nr(this.connection,{action:"",context:e})}onDialDown(e){return this.connection.addDisposableListener("dialDown",(t=>e(new Kt(new nr(this.connection,t),t))))}onDialRotate(e){return this.connection.addDisposableListener("dialRotate",(t=>e(new Kt(new nr(this.connection,t),t))))}onDialUp(e){return this.connection.addDisposableListener("dialUp",(t=>e(new Kt(new nr(this.connection,t),t))))}onKeyDown(e){return this.connection.addDisposableListener("keyDown",(t=>e(new Kt(new nr(this.connection,t),t))))}onKeyUp(e){return this.connection.addDisposableListener("keyUp",(t=>e(new Kt(new nr(this.connection,t),t))))}onTitleParametersDidChange(e){return this.connection.addDisposableListener("titleParametersDidChange",(t=>e(new Kt(new nr(this.connection,t),t))))}onTouchTap(e){return this.connection.addDisposableListener("touchTap",(t=>e(new Kt(new nr(this.connection,t),t))))}onWillAppear(e){return this.connection.addDisposableListener("willAppear",(t=>e(new Kt(new nr(this.connection,t),t))))}onWillDisappear(e){return this.connection.addDisposableListener("willDisappear",(t=>e(new Kt(new nr(this.connection,t),t))))}registerAction(e){if(void 0===e.manifestId)throw new Error("The action's manifestId cannot be undefined.");if(!this.manifest.Actions.some((t=>t.UUID===e.manifestId)))return void this.logger.warn(`Failed to route action: manifestId (UUID) ${e.manifestId} was not found in the manifest.`);const t=(t,r,n,o)=>{const s=o?.bind(e);void 0!==s&&n(r).bind(r)((async e=>{e.action.manifestId==t&&await s(e)}))};t(e.manifestId,this,(e=>e.onDialDown),e.onDialDown),t(e.manifestId,this,(e=>e.onDialUp),e.onDialUp),t(e.manifestId,this,(e=>e.onDialRotate),e.onDialRotate),t(e.manifestId,this,(e=>e.onKeyDown),e.onKeyDown),t(e.manifestId,this,(e=>e.onKeyUp),e.onKeyUp),t(e.manifestId,this,(e=>e.onTitleParametersDidChange),e.onTitleParametersDidChange),t(e.manifestId,this,(e=>e.onTouchTap),e.onTouchTap),t(e.manifestId,this,(e=>e.onWillAppear),e.onWillAppear),t(e.manifestId,this,(e=>e.onWillDisappear),e.onWillDisappear),t(e.manifestId,this.settingsClient,(e=>e.onDidReceiveSettings),e.onDidReceiveSettings),t(e.manifestId,this.uiClient,(e=>e.onPropertyInspectorDidAppear),e.onPropertyInspectorDidAppear),t(e.manifestId,this.uiClient,(e=>e.onPropertyInspectorDidDisappear),e.onPropertyInspectorDidDisappear),t(e.manifestId,this.uiClient,(e=>e.onSendToPlugin),e.onSendToPlugin)}}class sr{_promise;_reject;_resolve;constructor(){this._promise=new Promise(((e,t)=>{this._resolve=e,this._reject=t}))}get promise(){return this._promise}setException(e){this._reject&&this._reject(e)}setResult(e){this._resolve&&this._resolve(e)}}Symbol.dispose??=Symbol("Symbol.dispose");class ir{build;major;minor;patch;constructor(e){const t=e.match(/^(0|[1-9]\d*)(?:\.(0|[1-9]\d*))?(?:\.(0|[1-9]\d*))?(?:\.(0|[1-9]\d*))?$/);if(null===t)throw new Error(`Invalid format; expected "{major}[.{minor}[.{patch}[.{build}]]]" but was "${e}"`);[,this.major,this.minor,this.patch,this.build]=[...t.map((e=>parseInt(e)||0))]}compareTo(e){const t=({major:e,minor:t,build:r,patch:n})=>[e,t,r,n],r=t(this),n=t(e);for(let e=0;e<4;e++){if(r[e]<n[e])return-1;if(r[e]>n[e])return 1}return 0}toString(){return`${this.major}.${this.minor}`}}class ar extends o{registrationParameters;version;canConnect=!0;connection=new sr;logger;constructor(e,t){super(),this.registrationParameters=e,this.logger=t.createScope("StreamDeckConnection"),this.version=new ir(e.info.application.version)}addDisposableListener(e,t){return this.addListener(e,t),function(e){let t=!1;const r=()=>{t||(e(),t=!0)};return{[Symbol.dispose]:r,dispose:r}}((()=>this.removeListener(e,t)))}async connect(){if(this.canConnect){this.canConnect=!1,this.logger.debug("Connecting to Stream Deck.");const e=new Vt(`ws://127.0.0.1:${this.registrationParameters.port}`);e.on("error",(()=>this.resetConnection())),e.on("close",(()=>this.resetConnection())),e.on("message",(e=>this.tryEmit(e))),e.once("open",(()=>{e.send(JSON.stringify({event:this.registrationParameters.registerEvent,uuid:this.registrationParameters.pluginUUID})),this.logger.debug("Successfully connected to Stream Deck."),this.connection.setResult(e)}))}await this.connection.promise}async send(e){const t=await this.connection.promise,r=JSON.stringify(e);this.logger.trace(r),t.send(r)}resetConnection(){this.canConnect=!0,this.connection.setException(),this.connection=new sr}tryEmit(e){try{const t=JSON.parse(e.toString());t.event?(this.logger.trace(`${e}`),this.emit(t.event,t)):this.logger.warn(`Received unknown message: ${e}`)}catch(t){this.logger.error(`Failed to parse message: ${e}`,t)}}}var lr;!function(e){e.Port="-port",e.Info="-info",e.PluginUUID="-pluginUUID",e.RegisterEvent="-registerEvent"}(lr||(lr={}));class cr{info;pluginUUID;port;registerEvent;constructor(e,t){const r=t.createScope("RegistrationParameters");for(let t=0;t<e.length-1;t++){const n=e[t],o=e[++t];switch(n){case lr.Port:r.debug(`port=${o}`),this.port=o;break;case lr.PluginUUID:r.debug(`pluginUUID=${o}`),this.pluginUUID=o;break;case lr.RegisterEvent:r.debug(`registerEvent=${o}`),this.registerEvent=o;break;case lr.Info:r.debug(`info=${o}`),this.info=JSON.parse(o);break;default:t--}}const n=[],o=(e,t)=>{void 0===t&&n.push(e)};if(o(lr.Port,this.port),o(lr.PluginUUID,this.pluginUUID),o(lr.RegisterEvent,this.registerEvent),o(lr.Info,this.info),n.length>0)throw new Error(`Unable to establish a connection with Stream Deck, missing command line arguments: ${n.join(", ")}`)}}const ur=["de","en","es","fr","ja","zh_CN"];class dr{connection;devices=new Map;constructor(e){this.connection=e,e.registrationParameters.info.devices.forEach((e=>{this.devices.set(e.id,{...e,isConnected:!1})})),e.on("deviceDidConnect",(({device:e,deviceInfo:t})=>{this.devices.set(e,Object.assign(this.devices.get(e)||{},{id:e,isConnected:!0,...t}))})),e.on("deviceDidDisconnect",(({device:e})=>{const t=this.devices.get(e);void 0!==t&&(t.isConnected=!1)}))}get length(){return this.devices.size}[Symbol.iterator](){return this.devices.values()}forEach(e){this.devices.forEach((t=>e(t)))}getDeviceById(e){return this.devices.get(e)}onDeviceDidConnect(e){return this.connection.addDisposableListener("deviceDidConnect",(t=>e(new Jt(t,{...t.deviceInfo,id:t.device,isConnected:!0}))))}onDeviceDidDisconnect(e){return this.connection.addDisposableListener("deviceDidDisconnect",(t=>e(new Jt(t,{...this.devices.get(t.device),id:t.device,isConnected:!1}))))}}let hr;function fr(e,t){return e.split(".").reduce(((e,t)=>e&&e[t]),t)}function pr(){return void 0===hr&&(hr=process.execArgv.some((e=>{const t=e.split("=")[0];return"--inspect"===t||"--inspect-brk"===t||"--inspect-port"===t}))),hr}function mr(){const e=p.basename(process.cwd()),t=e.lastIndexOf(".sdPlugin");return t<0?e:e.substring(0,t)}class _r{language;logMissingKey=!0;static DEFAULT_LANGUAGE="en";locales=new Map;logger;constructor(e,t,r){this.language=e,this.logger=r.createScope("I18nProvider"),this.loadLocales(t)}translate(e,t=this.language){const r=this.translateOrDefault(e,t);return void 0===r&&this.logMissingKey&&this.logger.warn(`Missing translation: ${e}`),r||""}loadLocales(e){for(const e of d.readdirSync(process.cwd())){const{ext:t,name:r}=p.parse(e),n=r;if(".json"==t.toLowerCase()&&ur.includes(n)){const t=this.readFile(e);void 0!==t&&this.locales.set(n,t)}}this.locales.set(_r.DEFAULT_LANGUAGE,{...e,...this.locales.get(_r.DEFAULT_LANGUAGE)||{}})}readFile(e){try{const t=d.readFileSync(e,{flag:"r"})?.toString();return JSON.parse(t)}catch(t){this.logger.error(`Failed to load translations from ${e}`,t)}}translateOrDefault(e,t=this.language){return t===_r.DEFAULT_LANGUAGE?fr(e,this.locales.get(t))?.toString():fr(e,this.locales.get(t))?.toString()||fr(e,this.locales.get(_r.DEFAULT_LANGUAGE))?.toString()}}var gr;!function(e){e[e.ERROR=0]="ERROR",e[e.WARN=1]="WARN",e[e.INFO=2]="INFO",e[e.DEBUG=3]="DEBUG",e[e.TRACE=4]="TRACE"}(gr||(gr={}));class br{options;filePath;size=0;constructor(e){this.options=e,this.filePath=this.getLogFilePath(),this.reIndex()}write({level:e,message:t,error:r}){const n=d.openSync(this.filePath,"a"),o=e=>{d.writeSync(n,e),this.size+=e.length};try{o(`${(new Date).toISOString()} ${gr[e].padEnd(5)} ${t}${g}`),void 0!==r&&(r instanceof Object&&"message"in r&&r.message&&""!==r.message&&o(`${r.message}${g}`),r instanceof Object&&"stack"in r&&r.stack&&o(`${r.stack}${g}`))}finally{d.closeSync(n)}this.size>=this.options.maxSize&&(this.reIndex(),this.size=0)}getLogFilePath(e=0){return p.join(this.options.dest,`${this.options.fileName}.${e}.log`)}getLogFiles(){const e=/^\.(\d+)\.log$/;return d.readdirSync(this.options.dest,{withFileTypes:!0}).reduce(((t,r)=>{if(r.isDirectory()||r.name.indexOf(this.options.fileName)<0)return t;const n=r.name.substring(this.options.fileName.length).match(e);return 2!==n?.length||t.push({path:p.join(this.options.dest,r.name),index:parseInt(n[1])}),t}),[]).sort((({index:e},{index:t})=>e<t?-1:e>t?1:0))}reIndex(){if(!d.existsSync(this.options.dest))return void d.mkdirSync(this.options.dest);const e=this.getLogFiles();for(let t=e.length-1;t>=0;t--){const r=e[t];t>=this.options.maxFileCount-1?d.rmSync(r.path):d.renameSync(r.path,this.getLogFilePath(t+1))}}}class yr{_level;options;scope;constructor(e){this.options={...e},this.scope=void 0===this.options.scope||""===this.options.scope.trim()?"":`${this.options.scope}: `,"function"!=typeof this.options.level&&this.setLevel(this.options.level)}get level(){return void 0!==this._level?this._level:"function"==typeof this.options.level?this.options.level():this.options.level}createScope(e){return""===(e=e.trim())?this:new yr({...this.options,level:()=>this.level,scope:this.options.scope?`${this.options.scope}->${e}`:e})}debug(e,t){return this.log(gr.DEBUG,e,t)}error(e,t){return this.log(gr.ERROR,e,t)}info(e,t){return this.log(gr.INFO,e,t)}setLevel(e){return e!==gr.DEBUG&&e!==gr.TRACE||pr()?this._level=e:(this._level=gr.INFO,this.warn(`Log level cannot be set to ${gr[e]} whilst not in debug mode.`)),this}trace(e,t){return this.log(gr.TRACE,e,t)}warn(e,t){return this.log(gr.WARN,e,t)}log(e,t,r){return e<=this.level&&this.options.target.write({level:e,message:`${this.scope}${t}`,error:r}),this}}let wr,vr;function Sr(){return wr??=function(){const e=m(process.cwd(),"manifest.json");if(!h(e))throw new Error("Failed to read manifest.json as the file does not exist.");return JSON.parse(f(e,{encoding:"utf-8",flag:"r"}).toString())}()}function Er(e,t,r){const n={major:Math.floor(e),minor:e%1*10,patch:0,build:0};if(-1===t.compareTo(n))throw new Error(`[ERR_NOT_SUPPORTED]: ${r} requires Stream Deck version ${n.major}.${n.minor} or higher, but current version is ${t.major}.${t.minor}; please update Stream Deck and the "Software.MinimumVersion" in the plugin's manifest to "${n.major}.${n.minor}" or higher.`);if(-1===(vr??=new ir(Sr().Software.MinimumVersion)).compareTo(n))throw new Error(`[ERR_NOT_SUPPORTED]: ${r} requires Stream Deck version ${n.major}.${n.minor} or higher; please update the "Software.MinimumVersion" in the plugin's manifest to "${n.major}.${n.minor}" or higher.`)}class Tr{connection;constructor(e){this.connection=e}switchToProfile(e,t,r){return void 0!==r&&Er(6.5,this.connection.version,"Switching to a profile page"),this.connection.send({event:"switchToProfile",context:this.connection.registrationParameters.pluginUUID,device:e,payload:{page:r,profile:t}})}}class Rr{connection;constructor(e){this.connection=e}getGlobalSettings(){return new Promise((e=>{this.connection.once("didReceiveGlobalSettings",(t=>e(t.payload.settings))),this.connection.send({event:"getGlobalSettings",context:this.connection.registrationParameters.pluginUUID})}))}onDidReceiveGlobalSettings(e){return this.connection.addDisposableListener("didReceiveGlobalSettings",(t=>e(new rr(t))))}onDidReceiveSettings(e){return this.connection.addDisposableListener("didReceiveSettings",(t=>e(new Kt(new nr(this.connection,t),t))))}setGlobalSettings(e){return this.connection.send({event:"setGlobalSettings",context:this.connection.registrationParameters.pluginUUID,payload:e})}}class kr{connection;constructor(e){this.connection=e}onApplicationDidLaunch(e){return this.connection.addDisposableListener("applicationDidLaunch",(t=>e(new Qt(t))))}onApplicationDidTerminate(e){return this.connection.addDisposableListener("applicationDidTerminate",(t=>e(new Qt(t))))}onDidReceiveDeepLink(e){return Er(6.5,this.connection.version,"Receiving deep-link messages"),this.connection.addDisposableListener("didReceiveDeepLink",(t=>e(new Xt(t))))}onSystemDidWakeUp(e){return this.connection.addDisposableListener("systemDidWakeUp",(t=>e(new Gt(t))))}openUrl(e){return this.connection.send({event:"openUrl",payload:{url:e}})}}class Pr{connection;constructor(e){this.connection=e}onPropertyInspectorDidAppear(e){return this.connection.addDisposableListener("propertyInspectorDidAppear",(t=>e(new Yt(new nr(this.connection,t),t))))}onPropertyInspectorDidDisappear(e){return this.connection.addDisposableListener("propertyInspectorDidDisappear",(t=>e(new Yt(new nr(this.connection,t),t))))}onSendToPlugin(e){return this.connection.addDisposableListener("sendToPlugin",(t=>e(new tr(new nr(this.connection,t),t))))}}function Cr(e){const t=e.UUID;return function(e,r){return class extends e{manifestId=t}}}class Or{manifestId}var xr,Ar;!function(e){e[e.Rectangle=0]="Rectangle",e[e.DoubleRectangle=1]="DoubleRectangle",e[e.Trapezoid=2]="Trapezoid",e[e.DoubleTrapezoid=3]="DoubleTrapezoid",e[e.Groove=4]="Groove"}(xr||(xr={})),function(e){e[e.HardwareAndSoftware=0]="HardwareAndSoftware",e[e.Hardware=1]="Hardware",e[e.Software=2]="Software"}(Ar||(Ar={}));var Lr=new class{_actions;_connection;_devices;_i18n;_logger;_manifest;_profiles;_registrationParameters;_settings;_system;_ui;get actions(){return this._actions??=new or(this.connection,this.manifest,this.settings,this.ui,this.logger)}get devices(){return this._devices??=new dr(this.connection)}get i18n(){return this._i18n??=new _r(this.registrationParameters.info.application.language,this.manifest,this.logger)}get info(){return this.registrationParameters.info}get logger(){return this._logger??=function(){const e=new br({dest:p.join(_(),"logs"),fileName:mr(),maxFileCount:10,maxSize:52428800}),t=new yr({level:pr()?gr.DEBUG:gr.INFO,target:e});return process.once("uncaughtException",(e=>t.error("Process encountered uncaught exception",e))),t}()}get manifest(){return this._manifest??=Sr()}get profiles(){return this._profiles??=new Tr(this.connection)}get settings(){return this._settings??=new Rr(this.connection)}get system(){return this._system??=new kr(this.connection)}get ui(){return this._ui??=new Pr(this.connection)}get connection(){return this._connection??=(e=this.registrationParameters,t=this.logger,new ar(e,t));var e,t}get registrationParameters(){return this._registrationParameters??=new cr(process.argv,this.logger)}connect(){return void 0===this._devices&&(this._devices=new dr(this.connection)),this.connection.connect()}};"function"==typeof SuppressedError&&SuppressedError;var Dr,Ir={exports:{}};if(!globalThis.ReadableStream)try{const e=require("node:process"),{emitWarning:t}=e;try{e.emitWarning=()=>{},Object.assign(globalThis,require("node:stream/web")),e.emitWarning=t}catch(r){throw e.emitWarning=t,r}}catch(e){Object.assign(globalThis,(Dr||(Dr=1,function(e){const t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?Symbol:e=>`Symbol(${e})`;function r(){}function n(){return"undefined"!=typeof self?self:"undefined"!=typeof window?window:void 0!==x?x:void 0}const o=n();function s(e){return"object"==typeof e&&null!==e||"function"==typeof e}const i=r,a=Promise,l=Promise.prototype.then,c=Promise.resolve.bind(a),u=Promise.reject.bind(a);function d(e){return new a(e)}function h(e){return c(e)}function f(e){return u(e)}function p(e,t,r){return l.call(e,t,r)}function m(e,t,r){p(p(e,t,r),void 0,i)}function _(e,t){m(e,t)}function g(e,t){m(e,void 0,t)}function b(e,t,r){return p(e,t,r)}function y(e){p(e,void 0,i)}const w=(()=>{const e=o&&o.queueMicrotask;if("function"==typeof e)return e;const t=h(void 0);return e=>p(t,e)})();function v(e,t,r){if("function"!=typeof e)throw new TypeError("Argument is not a function");return Function.prototype.apply.call(e,t,r)}function S(e,t,r){try{return h(v(e,t,r))}catch(e){return f(e)}}const E=16384;class T{constructor(){this._cursor=0,this._size=0,this._front={_elements:[],_next:void 0},this._back=this._front,this._cursor=0,this._size=0}get length(){return this._size}push(e){const t=this._back;let r=t;t._elements.length===E-1&&(r={_elements:[],_next:void 0}),t._elements.push(e),r!==t&&(this._back=r,t._next=r),++this._size}shift(){const e=this._front;let t=e;const r=this._cursor;let n=r+1;const o=e._elements,s=o[r];return n===E&&(t=e._next,n=0),--this._size,this._cursor=n,e!==t&&(this._front=t),o[r]=void 0,s}forEach(e){let t=this._cursor,r=this._front,n=r._elements;for(;!(t===n.length&&void 0===r._next||t===n.length&&(r=r._next,n=r._elements,t=0,0===n.length));)e(n[t]),++t}peek(){const e=this._front,t=this._cursor;return e._elements[t]}}function R(e,t){e._ownerReadableStream=t,t._reader=e,"readable"===t._state?O(e):"closed"===t._state?L(e):A(e,t._storedError)}function k(e,t){return Rn(e._ownerReadableStream,t)}function P(e){"readable"===e._ownerReadableStream._state?D(e,new TypeError("Reader was released and can no longer be used to monitor the stream's closedness")):I(e,new TypeError("Reader was released and can no longer be used to monitor the stream's closedness")),e._ownerReadableStream._reader=void 0,e._ownerReadableStream=void 0}function C(e){return new TypeError("Cannot "+e+" a stream using a released reader")}function O(e){e._closedPromise=d(((t,r)=>{e._closedPromise_resolve=t,e._closedPromise_reject=r}))}function A(e,t){O(e),D(e,t)}function L(e){O(e),B(e)}function D(e,t){void 0!==e._closedPromise_reject&&(y(e._closedPromise),e._closedPromise_reject(t),e._closedPromise_resolve=void 0,e._closedPromise_reject=void 0)}function I(e,t){A(e,t)}function B(e){void 0!==e._closedPromise_resolve&&(e._closedPromise_resolve(void 0),e._closedPromise_resolve=void 0,e._closedPromise_reject=void 0)}const $=t("[[AbortSteps]]"),U=t("[[ErrorSteps]]"),j=t("[[CancelSteps]]"),q=t("[[PullSteps]]"),N=Number.isFinite||function(e){return"number"==typeof e&&isFinite(e)},F=Math.trunc||function(e){return e<0?Math.ceil(e):Math.floor(e)};function W(e){return"object"==typeof e||"function"==typeof e}function M(e,t){if(void 0!==e&&!W(e))throw new TypeError(`${t} is not an object.`)}function z(e,t){if("function"!=typeof e)throw new TypeError(`${t} is not a function.`)}function H(e){return"object"==typeof e&&null!==e||"function"==typeof e}function V(e,t){if(!H(e))throw new TypeError(`${t} is not an object.`)}function G(e,t,r){if(void 0===e)throw new TypeError(`Parameter ${t} is required in '${r}'.`)}function Y(e,t,r){if(void 0===e)throw new TypeError(`${t} is required in '${r}'.`)}function K(e){return Number(e)}function Q(e){return 0===e?0:e}function J(e){return Q(F(e))}function X(e,t){const r=0,n=Number.MAX_SAFE_INTEGER;let o=Number(e);if(o=Q(o),!N(o))throw new TypeError(`${t} is not a finite number`);if(o=J(o),o<r||o>n)throw new TypeError(`${t} is outside the accepted range of ${r} to ${n}, inclusive`);return N(o)&&0!==o?o:0}function Z(e,t){if(!En(e))throw new TypeError(`${t} is not a ReadableStream.`)}function ee(e){return new se(e)}function te(e,t){e._reader._readRequests.push(t)}function re(e,t,r){const n=e._reader._readRequests.shift();r?n._closeSteps():n._chunkSteps(t)}function ne(e){return e._reader._readRequests.length}function oe(e){const t=e._reader;return void 0!==t&&!!ie(t)}class se{constructor(e){if(G(e,1,"ReadableStreamDefaultReader"),Z(e,"First parameter"),Tn(e))throw new TypeError("This stream has already been locked for exclusive reading by another reader");R(this,e),this._readRequests=new T}get closed(){return ie(this)?this._closedPromise:f(le("closed"))}cancel(e=void 0){return ie(this)?void 0===this._ownerReadableStream?f(C("cancel")):k(this,e):f(le("cancel"))}read(){if(!ie(this))return f(le("read"));if(void 0===this._ownerReadableStream)return f(C("read from"));let e,t;const r=d(((r,n)=>{e=r,t=n})),n={_chunkSteps:t=>e({value:t,done:!1}),_closeSteps:()=>e({value:void 0,done:!0}),_errorSteps:e=>t(e)};return ae(this,n),r}releaseLock(){if(!ie(this))throw le("releaseLock");if(void 0!==this._ownerReadableStream){if(this._readRequests.length>0)throw new TypeError("Tried to release a reader lock when that reader has pending read() calls un-settled");P(this)}}}function ie(e){return!!s(e)&&!!Object.prototype.hasOwnProperty.call(e,"_readRequests")&&e instanceof se}function ae(e,t){const r=e._ownerReadableStream;r._disturbed=!0,"closed"===r._state?t._closeSteps():"errored"===r._state?t._errorSteps(r._storedError):r._readableStreamController[q](t)}function le(e){return new TypeError(`ReadableStreamDefaultReader.prototype.${e} can only be used on a ReadableStreamDefaultReader`)}Object.defineProperties(se.prototype,{cancel:{enumerable:!0},read:{enumerable:!0},releaseLock:{enumerable:!0},closed:{enumerable:!0}}),"symbol"==typeof t.toStringTag&&Object.defineProperty(se.prototype,t.toStringTag,{value:"ReadableStreamDefaultReader",configurable:!0});const ce=Object.getPrototypeOf(Object.getPrototypeOf((async function*(){})).prototype);class ue{constructor(e,t){this._ongoingPromise=void 0,this._isFinished=!1,this._reader=e,this._preventCancel=t}next(){const e=()=>this._nextSteps();return this._ongoingPromise=this._ongoingPromise?b(this._ongoingPromise,e,e):e(),this._ongoingPromise}return(e){const t=()=>this._returnSteps(e);return this._ongoingPromise?b(this._ongoingPromise,t,t):t()}_nextSteps(){if(this._isFinished)return Promise.resolve({value:void 0,done:!0});const e=this._reader;if(void 0===e._ownerReadableStream)return f(C("iterate"));let t,r;const n=d(((e,n)=>{t=e,r=n}));return ae(e,{_chunkSteps:e=>{this._ongoingPromise=void 0,w((()=>t({value:e,done:!1})))},_closeSteps:()=>{this._ongoingPromise=void 0,this._isFinished=!0,P(e),t({value:void 0,done:!0})},_errorSteps:t=>{this._ongoingPromise=void 0,this._isFinished=!0,P(e),r(t)}}),n}_returnSteps(e){if(this._isFinished)return Promise.resolve({value:e,done:!0});this._isFinished=!0;const t=this._reader;if(void 0===t._ownerReadableStream)return f(C("finish iterating"));if(!this._preventCancel){const r=k(t,e);return P(t),b(r,(()=>({value:e,done:!0})))}return P(t),h({value:e,done:!0})}}const de={next(){return fe(this)?this._asyncIteratorImpl.next():f(pe("next"))},return(e){return fe(this)?this._asyncIteratorImpl.return(e):f(pe("return"))}};function he(e,t){const r=ee(e),n=new ue(r,t),o=Object.create(de);return o._asyncIteratorImpl=n,o}function fe(e){if(!s(e))return!1;if(!Object.prototype.hasOwnProperty.call(e,"_asyncIteratorImpl"))return!1;try{return e._asyncIteratorImpl instanceof ue}catch(e){return!1}}function pe(e){return new TypeError(`ReadableStreamAsyncIterator.${e} can only be used on a ReadableSteamAsyncIterator`)}void 0!==ce&&Object.setPrototypeOf(de,ce);const me=Number.isNaN||function(e){return e!=e};function _e(e){return e.slice()}function ge(e,t,r,n,o){new Uint8Array(e).set(new Uint8Array(r,n,o),t)}function be(e){return e}function ye(e){return!1}function we(e,t,r){if(e.slice)return e.slice(t,r);const n=r-t,o=new ArrayBuffer(n);return ge(o,0,e,t,n),o}function ve(e){return!("number"!=typeof e||me(e)||e<0)}function Se(e){const t=we(e.buffer,e.byteOffset,e.byteOffset+e.byteLength);return new Uint8Array(t)}function Ee(e){const t=e._queue.shift();return e._queueTotalSize-=t.size,e._queueTotalSize<0&&(e._queueTotalSize=0),t.value}function Te(e,t,r){if(!ve(r)||r===1/0)throw new RangeError("Size must be a finite, non-NaN, non-negative number.");e._queue.push({value:t,size:r}),e._queueTotalSize+=r}function Re(e){return e._queue.peek().value}function ke(e){e._queue=new T,e._queueTotalSize=0}class Pe{constructor(){throw new TypeError("Illegal constructor")}get view(){if(!xe(this))throw ot("view");return this._view}respond(e){if(!xe(this))throw ot("respond");if(G(e,1,"respond"),e=X(e,"First parameter"),void 0===this._associatedReadableByteStreamController)throw new TypeError("This BYOB request has been invalidated");ye(this._view.buffer),Ze(this._associatedReadableByteStreamController,e)}respondWithNewView(e){if(!xe(this))throw ot("respondWithNewView");if(G(e,1,"respondWithNewView"),!ArrayBuffer.isView(e))throw new TypeError("You can only respond with array buffer views");if(void 0===this._associatedReadableByteStreamController)throw new TypeError("This BYOB request has been invalidated");ye(e.buffer),et(this._associatedReadableByteStreamController,e)}}Object.defineProperties(Pe.prototype,{respond:{enumerable:!0},respondWithNewView:{enumerable:!0},view:{enumerable:!0}}),"symbol"==typeof t.toStringTag&&Object.defineProperty(Pe.prototype,t.toStringTag,{value:"ReadableStreamBYOBRequest",configurable:!0});class Ce{constructor(){throw new TypeError("Illegal constructor")}get byobRequest(){if(!Oe(this))throw st("byobRequest");return Je(this)}get desiredSize(){if(!Oe(this))throw st("desiredSize");return Xe(this)}close(){if(!Oe(this))throw st("close");if(this._closeRequested)throw new TypeError("The stream has already been closed; do not close it again!");const e=this._controlledReadableByteStream._state;if("readable"!==e)throw new TypeError(`The stream (in ${e} state) is not in the readable state and cannot be closed`);Ye(this)}enqueue(e){if(!Oe(this))throw st("enqueue");if(G(e,1,"enqueue"),!ArrayBuffer.isView(e))throw new TypeError("chunk must be an array buffer view");if(0===e.byteLength)throw new TypeError("chunk must have non-zero byteLength");if(0===e.buffer.byteLength)throw new TypeError("chunk's buffer must have non-zero byteLength");if(this._closeRequested)throw new TypeError("stream is closed or draining");const t=this._controlledReadableByteStream._state;if("readable"!==t)throw new TypeError(`The stream (in ${t} state) is not in the readable state and cannot be enqueued to`);Ke(this,e)}error(e=void 0){if(!Oe(this))throw st("error");Qe(this,e)}[j](e){Le(this),ke(this);const t=this._cancelAlgorithm(e);return Ge(this),t}[q](e){const t=this._controlledReadableByteStream;if(this._queueTotalSize>0){const t=this._queue.shift();this._queueTotalSize-=t.byteLength,je(this);const r=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);return void e._chunkSteps(r)}const r=this._autoAllocateChunkSize;if(void 0!==r){let t;try{t=new ArrayBuffer(r)}catch(t){return void e._errorSteps(t)}const n={buffer:t,bufferByteLength:r,byteOffset:0,byteLength:r,bytesFilled:0,elementSize:1,viewConstructor:Uint8Array,readerType:"default"};this._pendingPullIntos.push(n)}te(t,e),Ae(this)}}function Oe(e){return!!s(e)&&!!Object.prototype.hasOwnProperty.call(e,"_controlledReadableByteStream")&&e instanceof Ce}function xe(e){return!!s(e)&&!!Object.prototype.hasOwnProperty.call(e,"_associatedReadableByteStreamController")&&e instanceof Pe}function Ae(e){Ve(e)&&(e._pulling?e._pullAgain=!0:(e._pulling=!0,m(e._pullAlgorithm(),(()=>{e._pulling=!1,e._pullAgain&&(e._pullAgain=!1,Ae(e))}),(t=>{Qe(e,t)}))))}function Le(e){qe(e),e._pendingPullIntos=new T}function De(e,t){let r=!1;"closed"===e._state&&(r=!0);const n=Ie(t);"default"===t.readerType?re(e,n,r):lt(e,n,r)}function Ie(e){const t=e.bytesFilled,r=e.elementSize;return new e.viewConstructor(e.buffer,e.byteOffset,t/r)}function Be(e,t,r,n){e._queue.push({buffer:t,byteOffset:r,byteLength:n}),e._queueTotalSize+=n}function $e(e,t){const r=t.elementSize,n=t.bytesFilled-t.bytesFilled%r,o=Math.min(e._queueTotalSize,t.byteLength-t.bytesFilled),s=t.bytesFilled+o,i=s-s%r;let a=o,l=!1;i>n&&(a=i-t.bytesFilled,l=!0);const c=e._queue;for(;a>0;){const r=c.peek(),n=Math.min(a,r.byteLength),o=t.byteOffset+t.bytesFilled;ge(t.buffer,o,r.buffer,r.byteOffset,n),r.byteLength===n?c.shift():(r.byteOffset+=n,r.byteLength-=n),e._queueTotalSize-=n,Ue(e,n,t),a-=n}return l}function Ue(e,t,r){r.bytesFilled+=t}function je(e){0===e._queueTotalSize&&e._closeRequested?(Ge(e),kn(e._controlledReadableByteStream)):Ae(e)}function qe(e){null!==e._byobRequest&&(e._byobRequest._associatedReadableByteStreamController=void 0,e._byobRequest._view=null,e._byobRequest=null)}function Ne(e){for(;e._pendingPullIntos.length>0;){if(0===e._queueTotalSize)return;const t=e._pendingPullIntos.peek();$e(e,t)&&(He(e),De(e._controlledReadableByteStream,t))}}function Fe(e,t,r){const n=e._controlledReadableByteStream;let o=1;t.constructor!==DataView&&(o=t.constructor.BYTES_PER_ELEMENT);const s=t.constructor,i=be(t.buffer),a={buffer:i,bufferByteLength:i.byteLength,byteOffset:t.byteOffset,byteLength:t.byteLength,bytesFilled:0,elementSize:o,viewConstructor:s,readerType:"byob"};if(e._pendingPullIntos.length>0)return e._pendingPullIntos.push(a),void at(n,r);if("closed"!==n._state){if(e._queueTotalSize>0){if($e(e,a)){const t=Ie(a);return je(e),void r._chunkSteps(t)}if(e._closeRequested){const t=new TypeError("Insufficient bytes to fill elements in the given buffer");return Qe(e,t),void r._errorSteps(t)}}e._pendingPullIntos.push(a),at(n,r),Ae(e)}else{const e=new s(a.buffer,a.byteOffset,0);r._closeSteps(e)}}function We(e,t){const r=e._controlledReadableByteStream;if(ut(r))for(;ct(r)>0;)De(r,He(e))}function Me(e,t,r){if(Ue(e,t,r),r.bytesFilled<r.elementSize)return;He(e);const n=r.bytesFilled%r.elementSize;if(n>0){const t=r.byteOffset+r.bytesFilled,o=we(r.buffer,t-n,t);Be(e,o,0,o.byteLength)}r.bytesFilled-=n,De(e._controlledReadableByteStream,r),Ne(e)}function ze(e,t){const r=e._pendingPullIntos.peek();qe(e),"closed"===e._controlledReadableByteStream._state?We(e):Me(e,t,r),Ae(e)}function He(e){return e._pendingPullIntos.shift()}function Ve(e){const t=e._controlledReadableByteStream;return"readable"===t._state&&!e._closeRequested&&!!e._started&&(!!(oe(t)&&ne(t)>0)||!!(ut(t)&&ct(t)>0)||Xe(e)>0)}function Ge(e){e._pullAlgorithm=void 0,e._cancelAlgorithm=void 0}function Ye(e){const t=e._controlledReadableByteStream;if(!e._closeRequested&&"readable"===t._state)if(e._queueTotalSize>0)e._closeRequested=!0;else{if(e._pendingPullIntos.length>0&&e._pendingPullIntos.peek().bytesFilled>0){const t=new TypeError("Insufficient bytes to fill elements in the given buffer");throw Qe(e,t),t}Ge(e),kn(t)}}function Ke(e,t){const r=e._controlledReadableByteStream;if(e._closeRequested||"readable"!==r._state)return;const n=t.buffer,o=t.byteOffset,s=t.byteLength,i=be(n);if(e._pendingPullIntos.length>0){const t=e._pendingPullIntos.peek();ye(t.buffer),t.buffer=be(t.buffer)}qe(e),oe(r)?0===ne(r)?Be(e,i,o,s):(e._pendingPullIntos.length>0&&He(e),re(r,new Uint8Array(i,o,s),!1)):ut(r)?(Be(e,i,o,s),Ne(e)):Be(e,i,o,s),Ae(e)}function Qe(e,t){const r=e._controlledReadableByteStream;"readable"===r._state&&(Le(e),ke(e),Ge(e),Pn(r,t))}function Je(e){if(null===e._byobRequest&&e._pendingPullIntos.length>0){const t=e._pendingPullIntos.peek(),r=new Uint8Array(t.buffer,t.byteOffset+t.bytesFilled,t.byteLength-t.bytesFilled),n=Object.create(Pe.prototype);nt(n,e,r),e._byobRequest=n}return e._byobRequest}function Xe(e){const t=e._controlledReadableByteStream._state;return"errored"===t?null:"closed"===t?0:e._strategyHWM-e._queueTotalSize}function Ze(e,t){const r=e._pendingPullIntos.peek();if("closed"===e._controlledReadableByteStream._state){if(0!==t)throw new TypeError("bytesWritten must be 0 when calling respond() on a closed stream")}else{if(0===t)throw new TypeError("bytesWritten must be greater than 0 when calling respond() on a readable stream");if(r.bytesFilled+t>r.byteLength)throw new RangeError("bytesWritten out of range")}r.buffer=be(r.buffer),ze(e,t)}function et(e,t){const r=e._pendingPullIntos.peek();if("closed"===e._controlledReadableByteStream._state){if(0!==t.byteLength)throw new TypeError("The view's length must be 0 when calling respondWithNewView() on a closed stream")}else if(0===t.byteLength)throw new TypeError("The view's length must be greater than 0 when calling respondWithNewView() on a readable stream");if(r.byteOffset+r.bytesFilled!==t.byteOffset)throw new RangeError("The region specified by view does not match byobRequest");if(r.bufferByteLength!==t.buffer.byteLength)throw new RangeError("The buffer of view has different capacity than byobRequest");if(r.bytesFilled+t.byteLength>r.byteLength)throw new RangeError("The region specified by view is larger than byobRequest");const n=t.byteLength;r.buffer=be(t.buffer),ze(e,n)}function tt(e,t,r,n,o,s,i){t._controlledReadableByteStream=e,t._pullAgain=!1,t._pulling=!1,t._byobRequest=null,t._queue=t._queueTotalSize=void 0,ke(t),t._closeRequested=!1,t._started=!1,t._strategyHWM=s,t._pullAlgorithm=n,t._cancelAlgorithm=o,t._autoAllocateChunkSize=i,t._pendingPullIntos=new T,e._readableStreamController=t,m(h(r()),(()=>{t._started=!0,Ae(t)}),(e=>{Qe(t,e)}))}function rt(e,t,r){const n=Object.create(Ce.prototype);let o=()=>{},s=()=>h(void 0),i=()=>h(void 0);void 0!==t.start&&(o=()=>t.start(n)),void 0!==t.pull&&(s=()=>t.pull(n)),void 0!==t.cancel&&(i=e=>t.cancel(e));const a=t.autoAllocateChunkSize;if(0===a)throw new TypeError("autoAllocateChunkSize must be greater than 0");tt(e,n,o,s,i,r,a)}function nt(e,t,r){e._associatedReadableByteStreamController=t,e._view=r}function ot(e){return new TypeError(`ReadableStreamBYOBRequest.prototype.${e} can only be used on a ReadableStreamBYOBRequest`)}function st(e){return new TypeError(`ReadableByteStreamController.prototype.${e} can only be used on a ReadableByteStreamController`)}function it(e){return new dt(e)}function at(e,t){e._reader._readIntoRequests.push(t)}function lt(e,t,r){const n=e._reader._readIntoRequests.shift();r?n._closeSteps(t):n._chunkSteps(t)}function ct(e){return e._reader._readIntoRequests.length}function ut(e){const t=e._reader;return void 0!==t&&!!ht(t)}Object.defineProperties(Ce.prototype,{close:{enumerable:!0},enqueue:{enumerable:!0},error:{enumerable:!0},byobRequest:{enumerable:!0},desiredSize:{enumerable:!0}}),"symbol"==typeof t.toStringTag&&Object.defineProperty(Ce.prototype,t.toStringTag,{value:"ReadableByteStreamController",configurable:!0});class dt{constructor(e){if(G(e,1,"ReadableStreamBYOBReader"),Z(e,"First parameter"),Tn(e))throw new TypeError("This stream has already been locked for exclusive reading by another reader");if(!Oe(e._readableStreamController))throw new TypeError("Cannot construct a ReadableStreamBYOBReader for a stream not constructed with a byte source");R(this,e),this._readIntoRequests=new T}get closed(){return ht(this)?this._closedPromise:f(pt("closed"))}cancel(e=void 0){return ht(this)?void 0===this._ownerReadableStream?f(C("cancel")):k(this,e):f(pt("cancel"))}read(e){if(!ht(this))return f(pt("read"));if(!ArrayBuffer.isView(e))return f(new TypeError("view must be an array buffer view"));if(0===e.byteLength)return f(new TypeError("view must have non-zero byteLength"));if(0===e.buffer.byteLength)return f(new TypeError("view's buffer must have non-zero byteLength"));if(ye(e.buffer),void 0===this._ownerReadableStream)return f(C("read from"));let t,r;const n=d(((e,n)=>{t=e,r=n})),o={_chunkSteps:e=>t({value:e,done:!1}),_closeSteps:e=>t({value:e,done:!0}),_errorSteps:e=>r(e)};return ft(this,e,o),n}releaseLock(){if(!ht(this))throw pt("releaseLock");if(void 0!==this._ownerReadableStream){if(this._readIntoRequests.length>0)throw new TypeError("Tried to release a reader lock when that reader has pending read() calls un-settled");P(this)}}}function ht(e){return!!s(e)&&!!Object.prototype.hasOwnProperty.call(e,"_readIntoRequests")&&e instanceof dt}function ft(e,t,r){const n=e._ownerReadableStream;n._disturbed=!0,"errored"===n._state?r._errorSteps(n._storedError):Fe(n._readableStreamController,t,r)}function pt(e){return new TypeError(`ReadableStreamBYOBReader.prototype.${e} can only be used on a ReadableStreamBYOBReader`)}function mt(e,t){const{highWaterMark:r}=e;if(void 0===r)return t;if(me(r)||r<0)throw new RangeError("Invalid highWaterMark");return r}function _t(e){const{size:t}=e;return t||(()=>1)}function gt(e,t){M(e,t);const r=null==e?void 0:e.highWaterMark,n=null==e?void 0:e.size;return{highWaterMark:void 0===r?void 0:K(r),size:void 0===n?void 0:bt(n,`${t} has member 'size' that`)}}function bt(e,t){return z(e,t),t=>K(e(t))}function yt(e,t){M(e,t);const r=null==e?void 0:e.abort,n=null==e?void 0:e.close,o=null==e?void 0:e.start,s=null==e?void 0:e.type,i=null==e?void 0:e.write;return{abort:void 0===r?void 0:wt(r,e,`${t} has member 'abort' that`),close:void 0===n?void 0:vt(n,e,`${t} has member 'close' that`),start:void 0===o?void 0:St(o,e,`${t} has member 'start' that`),write:void 0===i?void 0:Et(i,e,`${t} has member 'write' that`),type:s}}function wt(e,t,r){return z(e,r),r=>S(e,t,[r])}function vt(e,t,r){return z(e,r),()=>S(e,t,[])}function St(e,t,r){return z(e,r),r=>v(e,t,[r])}function Et(e,t,r){return z(e,r),(r,n)=>S(e,t,[r,n])}function Tt(e,t){if(!Lt(e))throw new TypeError(`${t} is not a WritableStream.`)}function Rt(e){if("object"!=typeof e||null===e)return!1;try{return"boolean"==typeof e.aborted}catch(e){return!1}}Object.defineProperties(dt.prototype,{cancel:{enumerable:!0},read:{enumerable:!0},releaseLock:{enumerable:!0},closed:{enumerable:!0}}),"symbol"==typeof t.toStringTag&&Object.defineProperty(dt.prototype,t.toStringTag,{value:"ReadableStreamBYOBReader",configurable:!0});const kt="function"==typeof AbortController;function Pt(){if(kt)return new AbortController}class Ct{constructor(e={},t={}){void 0===e?e=null:V(e,"First parameter");const r=gt(t,"Second parameter"),n=yt(e,"First parameter");if(At(this),void 0!==n.type)throw new RangeError("Invalid type is specified");const o=_t(r);ur(this,n,mt(r,1),o)}get locked(){if(!Lt(this))throw Sr("locked");return Dt(this)}abort(e=void 0){return Lt(this)?Dt(this)?f(new TypeError("Cannot abort a stream that already has a writer")):It(this,e):f(Sr("abort"))}close(){return Lt(this)?Dt(this)?f(new TypeError("Cannot close a stream that already has a writer")):zt(this)?f(new TypeError("Cannot close an already-closing stream")):Bt(this):f(Sr("close"))}getWriter(){if(!Lt(this))throw Sr("getWriter");return Ot(this)}}function Ot(e){return new Qt(e)}function xt(e,t,r,n,o=1,s=(()=>1)){const i=Object.create(Ct.prototype);return At(i),cr(i,Object.create(ar.prototype),e,t,r,n,o,s),i}function At(e){e._state="writable",e._storedError=void 0,e._writer=void 0,e._writableStreamController=void 0,e._writeRequests=new T,e._inFlightWriteRequest=void 0,e._closeRequest=void 0,e._inFlightCloseRequest=void 0,e._pendingAbortRequest=void 0,e._backpressure=!1}function Lt(e){return!!s(e)&&!!Object.prototype.hasOwnProperty.call(e,"_writableStreamController")&&e instanceof Ct}function Dt(e){return void 0!==e._writer}function It(e,t){var r;if("closed"===e._state||"errored"===e._state)return h(void 0);e._writableStreamController._abortReason=t,null===(r=e._writableStreamController._abortController)||void 0===r||r.abort();const n=e._state;if("closed"===n||"errored"===n)return h(void 0);if(void 0!==e._pendingAbortRequest)return e._pendingAbortRequest._promise;let o=!1;"erroring"===n&&(o=!0,t=void 0);const s=d(((r,n)=>{e._pendingAbortRequest={_promise:void 0,_resolve:r,_reject:n,_reason:t,_wasAlreadyErroring:o}}));return e._pendingAbortRequest._promise=s,o||jt(e,t),s}function Bt(e){const t=e._state;if("closed"===t||"errored"===t)return f(new TypeError(`The stream (in ${t} state) is not in the writable state and cannot be closed`));const r=d(((t,r)=>{const n={_resolve:t,_reject:r};e._closeRequest=n})),n=e._writer;return void 0!==n&&e._backpressure&&"writable"===t&&jr(n),hr(e._writableStreamController),r}function $t(e){return d(((t,r)=>{const n={_resolve:t,_reject:r};e._writeRequests.push(n)}))}function Ut(e,t){"writable"!==e._state?qt(e):jt(e,t)}function jt(e,t){const r=e._writableStreamController;e._state="erroring",e._storedError=t;const n=e._writer;void 0!==n&&rr(n,t),!Ht(e)&&r._started&&qt(e)}function qt(e){e._state="errored",e._writableStreamController[U]();const t=e._storedError;if(e._writeRequests.forEach((e=>{e._reject(t)})),e._writeRequests=new T,void 0===e._pendingAbortRequest)return void Yt(e);const r=e._pendingAbortRequest;if(e._pendingAbortRequest=void 0,r._wasAlreadyErroring)return r._reject(t),void Yt(e);m(e._writableStreamController[$](r._reason),(()=>{r._resolve(),Yt(e)}),(t=>{r._reject(t),Yt(e)}))}function Nt(e){e._inFlightWriteRequest._resolve(void 0),e._inFlightWriteRequest=void 0}function Ft(e,t){e._inFlightWriteRequest._reject(t),e._inFlightWriteRequest=void 0,Ut(e,t)}function Wt(e){e._inFlightCloseRequest._resolve(void 0),e._inFlightCloseRequest=void 0,"erroring"===e._state&&(e._storedError=void 0,void 0!==e._pendingAbortRequest&&(e._pendingAbortRequest._resolve(),e._pendingAbortRequest=void 0)),e._state="closed";const t=e._writer;void 0!==t&&Ar(t)}function Mt(e,t){e._inFlightCloseRequest._reject(t),e._inFlightCloseRequest=void 0,void 0!==e._pendingAbortRequest&&(e._pendingAbortRequest._reject(t),e._pendingAbortRequest=void 0),Ut(e,t)}function zt(e){return void 0!==e._closeRequest||void 0!==e._inFlightCloseRequest}function Ht(e){return void 0!==e._inFlightWriteRequest||void 0!==e._inFlightCloseRequest}function Vt(e){e._inFlightCloseRequest=e._closeRequest,e._closeRequest=void 0}function Gt(e){e._inFlightWriteRequest=e._writeRequests.shift()}function Yt(e){void 0!==e._closeRequest&&(e._closeRequest._reject(e._storedError),e._closeRequest=void 0);const t=e._writer;void 0!==t&&Or(t,e._storedError)}function Kt(e,t){const r=e._writer;void 0!==r&&t!==e._backpressure&&(t?$r(r):jr(r)),e._backpressure=t}Object.defineProperties(Ct.prototype,{abort:{enumerable:!0},close:{enumerable:!0},getWriter:{enumerable:!0},locked:{enumerable:!0}}),"symbol"==typeof t.toStringTag&&Object.defineProperty(Ct.prototype,t.toStringTag,{value:"WritableStream",configurable:!0});class Qt{constructor(e){if(G(e,1,"WritableStreamDefaultWriter"),Tt(e,"First parameter"),Dt(e))throw new TypeError("This stream has already been locked for exclusive writing by another writer");this._ownerWritableStream=e,e._writer=this;const t=e._state;if("writable"===t)!zt(e)&&e._backpressure?Lr(this):Ir(this),kr(this);else if("erroring"===t)Dr(this,e._storedError),kr(this);else if("closed"===t)Ir(this),Cr(this);else{const t=e._storedError;Dr(this,t),Pr(this,t)}}get closed(){return Jt(this)?this._closedPromise:f(Tr("closed"))}get desiredSize(){if(!Jt(this))throw Tr("desiredSize");if(void 0===this._ownerWritableStream)throw Rr("desiredSize");return nr(this)}get ready(){return Jt(this)?this._readyPromise:f(Tr("ready"))}abort(e=void 0){return Jt(this)?void 0===this._ownerWritableStream?f(Rr("abort")):Xt(this,e):f(Tr("abort"))}close(){if(!Jt(this))return f(Tr("close"));const e=this._ownerWritableStream;return void 0===e?f(Rr("close")):zt(e)?f(new TypeError("Cannot close an already-closing stream")):Zt(this)}releaseLock(){if(!Jt(this))throw Tr("releaseLock");void 0!==this._ownerWritableStream&&or(this)}write(e=void 0){return Jt(this)?void 0===this._ownerWritableStream?f(Rr("write to")):sr(this,e):f(Tr("write"))}}function Jt(e){return!!s(e)&&!!Object.prototype.hasOwnProperty.call(e,"_ownerWritableStream")&&e instanceof Qt}function Xt(e,t){return It(e._ownerWritableStream,t)}function Zt(e){return Bt(e._ownerWritableStream)}function er(e){const t=e._ownerWritableStream,r=t._state;return zt(t)||"closed"===r?h(void 0):"errored"===r?f(t._storedError):Zt(e)}function tr(e,t){"pending"===e._closedPromiseState?Or(e,t):xr(e,t)}function rr(e,t){"pending"===e._readyPromiseState?Br(e,t):Ur(e,t)}function nr(e){const t=e._ownerWritableStream,r=t._state;return"errored"===r||"erroring"===r?null:"closed"===r?0:pr(t._writableStreamController)}function or(e){const t=e._ownerWritableStream,r=new TypeError("Writer was released and can no longer be used to monitor the stream's closedness");rr(e,r),tr(e,r),t._writer=void 0,e._ownerWritableStream=void 0}function sr(e,t){const r=e._ownerWritableStream,n=r._writableStreamController,o=fr(n,t);if(r!==e._ownerWritableStream)return f(Rr("write to"));const s=r._state;if("errored"===s)return f(r._storedError);if(zt(r)||"closed"===s)return f(new TypeError("The stream is closing or closed and cannot be written to"));if("erroring"===s)return f(r._storedError);const i=$t(r);return mr(n,t,o),i}Object.defineProperties(Qt.prototype,{abort:{enumerable:!0},close:{enumerable:!0},releaseLock:{enumerable:!0},write:{enumerable:!0},closed:{enumerable:!0},desiredSize:{enumerable:!0},ready:{enumerable:!0}}),"symbol"==typeof t.toStringTag&&Object.defineProperty(Qt.prototype,t.toStringTag,{value:"WritableStreamDefaultWriter",configurable:!0});const ir={};class ar{constructor(){throw new TypeError("Illegal constructor")}get abortReason(){if(!lr(this))throw Er("abortReason");return this._abortReason}get signal(){if(!lr(this))throw Er("signal");if(void 0===this._abortController)throw new TypeError("WritableStreamDefaultController.prototype.signal is not supported");return this._abortController.signal}error(e=void 0){if(!lr(this))throw Er("error");"writable"===this._controlledWritableStream._state&&vr(this,e)}[$](e){const t=this._abortAlgorithm(e);return dr(this),t}[U](){ke(this)}}function lr(e){return!!s(e)&&!!Object.prototype.hasOwnProperty.call(e,"_controlledWritableStream")&&e instanceof ar}function cr(e,t,r,n,o,s,i,a){t._controlledWritableStream=e,e._writableStreamController=t,t._queue=void 0,t._queueTotalSize=void 0,ke(t),t._abortReason=void 0,t._abortController=Pt(),t._started=!1,t._strategySizeAlgorithm=a,t._strategyHWM=i,t._writeAlgorithm=n,t._closeAlgorithm=o,t._abortAlgorithm=s;const l=wr(t);Kt(e,l),m(h(r()),(()=>{t._started=!0,_r(t)}),(r=>{t._started=!0,Ut(e,r)}))}function ur(e,t,r,n){const o=Object.create(ar.prototype);let s=()=>{},i=()=>h(void 0),a=()=>h(void 0),l=()=>h(void 0);void 0!==t.start&&(s=()=>t.start(o)),void 0!==t.write&&(i=e=>t.write(e,o)),void 0!==t.close&&(a=()=>t.close()),void 0!==t.abort&&(l=e=>t.abort(e)),cr(e,o,s,i,a,l,r,n)}function dr(e){e._writeAlgorithm=void 0,e._closeAlgorithm=void 0,e._abortAlgorithm=void 0,e._strategySizeAlgorithm=void 0}function hr(e){Te(e,ir,0),_r(e)}function fr(e,t){try{return e._strategySizeAlgorithm(t)}catch(t){return gr(e,t),1}}function pr(e){return e._strategyHWM-e._queueTotalSize}function mr(e,t,r){try{Te(e,t,r)}catch(t){return void gr(e,t)}const n=e._controlledWritableStream;zt(n)||"writable"!==n._state||Kt(n,wr(e)),_r(e)}function _r(e){const t=e._controlledWritableStream;if(!e._started)return;if(void 0!==t._inFlightWriteRequest)return;if("erroring"===t._state)return void qt(t);if(0===e._queue.length)return;const r=Re(e);r===ir?br(e):yr(e,r)}function gr(e,t){"writable"===e._controlledWritableStream._state&&vr(e,t)}function br(e){const t=e._controlledWritableStream;Vt(t),Ee(e);const r=e._closeAlgorithm();dr(e),m(r,(()=>{Wt(t)}),(e=>{Mt(t,e)}))}function yr(e,t){const r=e._controlledWritableStream;Gt(r),m(e._writeAlgorithm(t),(()=>{Nt(r);const t=r._state;if(Ee(e),!zt(r)&&"writable"===t){const t=wr(e);Kt(r,t)}_r(e)}),(t=>{"writable"===r._state&&dr(e),Ft(r,t)}))}function wr(e){return pr(e)<=0}function vr(e,t){const r=e._controlledWritableStream;dr(e),jt(r,t)}function Sr(e){return new TypeError(`WritableStream.prototype.${e} can only be used on a WritableStream`)}function Er(e){return new TypeError(`WritableStreamDefaultController.prototype.${e} can only be used on a WritableStreamDefaultController`)}function Tr(e){return new TypeError(`WritableStreamDefaultWriter.prototype.${e} can only be used on a WritableStreamDefaultWriter`)}function Rr(e){return new TypeError("Cannot "+e+" a stream using a released writer")}function kr(e){e._closedPromise=d(((t,r)=>{e._closedPromise_resolve=t,e._closedPromise_reject=r,e._closedPromiseState="pending"}))}function Pr(e,t){kr(e),Or(e,t)}function Cr(e){kr(e),Ar(e)}function Or(e,t){void 0!==e._closedPromise_reject&&(y(e._closedPromise),e._closedPromise_reject(t),e._closedPromise_resolve=void 0,e._closedPromise_reject=void 0,e._closedPromiseState="rejected")}function xr(e,t){Pr(e,t)}function Ar(e){void 0!==e._closedPromise_resolve&&(e._closedPromise_resolve(void 0),e._closedPromise_resolve=void 0,e._closedPromise_reject=void 0,e._closedPromiseState="resolved")}function Lr(e){e._readyPromise=d(((t,r)=>{e._readyPromise_resolve=t,e._readyPromise_reject=r})),e._readyPromiseState="pending"}function Dr(e,t){Lr(e),Br(e,t)}function Ir(e){Lr(e),jr(e)}function Br(e,t){void 0!==e._readyPromise_reject&&(y(e._readyPromise),e._readyPromise_reject(t),e._readyPromise_resolve=void 0,e._readyPromise_reject=void 0,e._readyPromiseState="rejected")}function $r(e){Lr(e)}function Ur(e,t){Dr(e,t)}function jr(e){void 0!==e._readyPromise_resolve&&(e._readyPromise_resolve(void 0),e._readyPromise_resolve=void 0,e._readyPromise_reject=void 0,e._readyPromiseState="fulfilled")}Object.defineProperties(ar.prototype,{abortReason:{enumerable:!0},signal:{enumerable:!0},error:{enumerable:!0}}),"symbol"==typeof t.toStringTag&&Object.defineProperty(ar.prototype,t.toStringTag,{value:"WritableStreamDefaultController",configurable:!0});const qr="undefined"!=typeof DOMException?DOMException:void 0;function Nr(e){if("function"!=typeof e&&"object"!=typeof e)return!1;try{return new e,!0}catch(e){return!1}}function Fr(){const e=function(e,t){this.message=e||"",this.name=t||"Error",Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)};return e.prototype=Object.create(Error.prototype),Object.defineProperty(e.prototype,"constructor",{value:e,writable:!0,configurable:!0}),e}const Wr=Nr(qr)?qr:Fr();function Mr(e,t,n,o,s,i){const a=ee(e),l=Ot(t);e._disturbed=!0;let c=!1,u=h(void 0);return d(((f,b)=>{let w;if(void 0!==i){if(w=()=>{const r=new Wr("Aborted","AbortError"),n=[];o||n.push((()=>"writable"===t._state?It(t,r):h(void 0))),s||n.push((()=>"readable"===e._state?Rn(e,r):h(void 0))),k((()=>Promise.all(n.map((e=>e())))),!0,r)},i.aborted)return void w();i.addEventListener("abort",w)}function v(){return d(((e,t)=>{function r(n){n?e():p(S(),r,t)}r(!1)}))}function S(){return c?h(!0):p(l._readyPromise,(()=>d(((e,t)=>{ae(a,{_chunkSteps:t=>{u=p(sr(l,t),void 0,r),e(!1)},_closeSteps:()=>e(!0),_errorSteps:t})}))))}if(T(e,a._closedPromise,(e=>{o?C(!0,e):k((()=>It(t,e)),!0,e)})),T(t,l._closedPromise,(t=>{s?C(!0,t):k((()=>Rn(e,t)),!0,t)})),R(e,a._closedPromise,(()=>{n?C():k((()=>er(l)))})),zt(t)||"closed"===t._state){const t=new TypeError("the destination writable stream closed before all data could be piped to it");s?C(!0,t):k((()=>Rn(e,t)),!0,t)}function E(){const e=u;return p(u,(()=>e!==u?E():void 0))}function T(e,t,r){"errored"===e._state?r(e._storedError):g(t,r)}function R(e,t,r){"closed"===e._state?r():_(t,r)}function k(e,r,n){function o(){m(e(),(()=>O(r,n)),(e=>O(!0,e)))}c||(c=!0,"writable"!==t._state||zt(t)?o():_(E(),o))}function C(e,r){c||(c=!0,"writable"!==t._state||zt(t)?O(e,r):_(E(),(()=>O(e,r))))}function O(e,t){or(l),P(a),void 0!==i&&i.removeEventListener("abort",w),e?b(t):f(void 0)}y(v())}))}class zr{constructor(){throw new TypeError("Illegal constructor")}get desiredSize(){if(!Hr(this))throw nn("desiredSize");return Xr(this)}close(){if(!Hr(this))throw nn("close");if(!en(this))throw new TypeError("The stream is not in a state that permits close");Kr(this)}enqueue(e=void 0){if(!Hr(this))throw nn("enqueue");if(!en(this))throw new TypeError("The stream is not in a state that permits enqueue");return Qr(this,e)}error(e=void 0){if(!Hr(this))throw nn("error");Jr(this,e)}[j](e){ke(this);const t=this._cancelAlgorithm(e);return Yr(this),t}[q](e){const t=this._controlledReadableStream;if(this._queue.length>0){const r=Ee(this);this._closeRequested&&0===this._queue.length?(Yr(this),kn(t)):Vr(this),e._chunkSteps(r)}else te(t,e),Vr(this)}}function Hr(e){return!!s(e)&&!!Object.prototype.hasOwnProperty.call(e,"_controlledReadableStream")&&e instanceof zr}function Vr(e){Gr(e)&&(e._pulling?e._pullAgain=!0:(e._pulling=!0,m(e._pullAlgorithm(),(()=>{e._pulling=!1,e._pullAgain&&(e._pullAgain=!1,Vr(e))}),(t=>{Jr(e,t)}))))}function Gr(e){const t=e._controlledReadableStream;return!!en(e)&&!!e._started&&(!!(Tn(t)&&ne(t)>0)||Xr(e)>0)}function Yr(e){e._pullAlgorithm=void 0,e._cancelAlgorithm=void 0,e._strategySizeAlgorithm=void 0}function Kr(e){if(!en(e))return;const t=e._controlledReadableStream;e._closeRequested=!0,0===e._queue.length&&(Yr(e),kn(t))}function Qr(e,t){if(!en(e))return;const r=e._controlledReadableStream;if(Tn(r)&&ne(r)>0)re(r,t,!1);else{let r;try{r=e._strategySizeAlgorithm(t)}catch(t){throw Jr(e,t),t}try{Te(e,t,r)}catch(t){throw Jr(e,t),t}}Vr(e)}function Jr(e,t){const r=e._controlledReadableStream;"readable"===r._state&&(ke(e),Yr(e),Pn(r,t))}function Xr(e){const t=e._controlledReadableStream._state;return"errored"===t?null:"closed"===t?0:e._strategyHWM-e._queueTotalSize}function Zr(e){return!Gr(e)}function en(e){const t=e._controlledReadableStream._state;return!e._closeRequested&&"readable"===t}function tn(e,t,r,n,o,s,i){t._controlledReadableStream=e,t._queue=void 0,t._queueTotalSize=void 0,ke(t),t._started=!1,t._closeRequested=!1,t._pullAgain=!1,t._pulling=!1,t._strategySizeAlgorithm=i,t._strategyHWM=s,t._pullAlgorithm=n,t._cancelAlgorithm=o,e._readableStreamController=t,m(h(r()),(()=>{t._started=!0,Vr(t)}),(e=>{Jr(t,e)}))}function rn(e,t,r,n){const o=Object.create(zr.prototype);let s=()=>{},i=()=>h(void 0),a=()=>h(void 0);void 0!==t.start&&(s=()=>t.start(o)),void 0!==t.pull&&(i=()=>t.pull(o)),void 0!==t.cancel&&(a=e=>t.cancel(e)),tn(e,o,s,i,a,r,n)}function nn(e){return new TypeError(`ReadableStreamDefaultController.prototype.${e} can only be used on a ReadableStreamDefaultController`)}function on(e,t){return Oe(e._readableStreamController)?an(e):sn(e)}function sn(e,t){const r=ee(e);let n,o,s,i,a,l=!1,c=!1,u=!1,f=!1;const p=d((e=>{a=e}));function m(){return l?(c=!0,h(void 0)):(l=!0,ae(r,{_chunkSteps:e=>{w((()=>{c=!1;const t=e,r=e;u||Qr(s._readableStreamController,t),f||Qr(i._readableStreamController,r),l=!1,c&&m()}))},_closeSteps:()=>{l=!1,u||Kr(s._readableStreamController),f||Kr(i._readableStreamController),u&&f||a(void 0)},_errorSteps:()=>{l=!1}}),h(void 0))}function _(t){if(u=!0,n=t,f){const t=_e([n,o]),r=Rn(e,t);a(r)}return p}function b(t){if(f=!0,o=t,u){const t=_e([n,o]),r=Rn(e,t);a(r)}return p}function y(){}return s=wn(y,m,_),i=wn(y,m,b),g(r._closedPromise,(e=>{Jr(s._readableStreamController,e),Jr(i._readableStreamController,e),u&&f||a(void 0)})),[s,i]}function an(e){let t,r,n,o,s,i=ee(e),a=!1,l=!1,c=!1,u=!1,f=!1;const p=d((e=>{s=e}));function m(e){g(e._closedPromise,(t=>{e===i&&(Qe(n._readableStreamController,t),Qe(o._readableStreamController,t),u&&f||s(void 0))}))}function _(){ht(i)&&(P(i),i=ee(e),m(i)),ae(i,{_chunkSteps:t=>{w((()=>{l=!1,c=!1;const r=t;let i=t;if(!u&&!f)try{i=Se(t)}catch(t){return Qe(n._readableStreamController,t),Qe(o._readableStreamController,t),void s(Rn(e,t))}u||Ke(n._readableStreamController,r),f||Ke(o._readableStreamController,i),a=!1,l?y():c&&v()}))},_closeSteps:()=>{a=!1,u||Ye(n._readableStreamController),f||Ye(o._readableStreamController),n._readableStreamController._pendingPullIntos.length>0&&Ze(n._readableStreamController,0),o._readableStreamController._pendingPullIntos.length>0&&Ze(o._readableStreamController,0),u&&f||s(void 0)},_errorSteps:()=>{a=!1}})}function b(t,r){ie(i)&&(P(i),i=it(e),m(i));const d=r?o:n,h=r?n:o;ft(i,t,{_chunkSteps:t=>{w((()=>{l=!1,c=!1;const n=r?f:u;if(r?u:f)n||et(d._readableStreamController,t);else{let r;try{r=Se(t)}catch(t){return Qe(d._readableStreamController,t),Qe(h._readableStreamController,t),void s(Rn(e,t))}n||et(d._readableStreamController,t),Ke(h._readableStreamController,r)}a=!1,l?y():c&&v()}))},_closeSteps:e=>{a=!1;const t=r?f:u,n=r?u:f;t||Ye(d._readableStreamController),n||Ye(h._readableStreamController),void 0!==e&&(t||et(d._readableStreamController,e),!n&&h._readableStreamController._pendingPullIntos.length>0&&Ze(h._readableStreamController,0)),t&&n||s(void 0)},_errorSteps:()=>{a=!1}})}function y(){if(a)return l=!0,h(void 0);a=!0;const e=Je(n._readableStreamController);return null===e?_():b(e._view,!1),h(void 0)}function v(){if(a)return c=!0,h(void 0);a=!0;const e=Je(o._readableStreamController);return null===e?_():b(e._view,!0),h(void 0)}function S(n){if(u=!0,t=n,f){const n=_e([t,r]),o=Rn(e,n);s(o)}return p}function E(n){if(f=!0,r=n,u){const n=_e([t,r]),o=Rn(e,n);s(o)}return p}function T(){}return n=vn(T,y,S),o=vn(T,v,E),m(i),[n,o]}function ln(e,t){M(e,t);const r=e,n=null==r?void 0:r.autoAllocateChunkSize,o=null==r?void 0:r.cancel,s=null==r?void 0:r.pull,i=null==r?void 0:r.start,a=null==r?void 0:r.type;return{autoAllocateChunkSize:void 0===n?void 0:X(n,`${t} has member 'autoAllocateChunkSize' that`),cancel:void 0===o?void 0:cn(o,r,`${t} has member 'cancel' that`),pull:void 0===s?void 0:un(s,r,`${t} has member 'pull' that`),start:void 0===i?void 0:dn(i,r,`${t} has member 'start' that`),type:void 0===a?void 0:hn(a,`${t} has member 'type' that`)}}function cn(e,t,r){return z(e,r),r=>S(e,t,[r])}function un(e,t,r){return z(e,r),r=>S(e,t,[r])}function dn(e,t,r){return z(e,r),r=>v(e,t,[r])}function hn(e,t){if("bytes"!=(e=`${e}`))throw new TypeError(`${t} '${e}' is not a valid enumeration value for ReadableStreamType`);return e}function fn(e,t){M(e,t);const r=null==e?void 0:e.mode;return{mode:void 0===r?void 0:pn(r,`${t} has member 'mode' that`)}}function pn(e,t){if("byob"!=(e=`${e}`))throw new TypeError(`${t} '${e}' is not a valid enumeration value for ReadableStreamReaderMode`);return e}function mn(e,t){M(e,t);const r=null==e?void 0:e.preventCancel;return{preventCancel:Boolean(r)}}function _n(e,t){M(e,t);const r=null==e?void 0:e.preventAbort,n=null==e?void 0:e.preventCancel,o=null==e?void 0:e.preventClose,s=null==e?void 0:e.signal;return void 0!==s&&gn(s,`${t} has member 'signal' that`),{preventAbort:Boolean(r),preventCancel:Boolean(n),preventClose:Boolean(o),signal:s}}function gn(e,t){if(!Rt(e))throw new TypeError(`${t} is not an AbortSignal.`)}function bn(e,t){M(e,t);const r=null==e?void 0:e.readable;Y(r,"readable","ReadableWritablePair"),Z(r,`${t} has member 'readable' that`);const n=null==e?void 0:e.writable;return Y(n,"writable","ReadableWritablePair"),Tt(n,`${t} has member 'writable' that`),{readable:r,writable:n}}Object.defineProperties(zr.prototype,{close:{enumerable:!0},enqueue:{enumerable:!0},error:{enumerable:!0},desiredSize:{enumerable:!0}}),"symbol"==typeof t.toStringTag&&Object.defineProperty(zr.prototype,t.toStringTag,{value:"ReadableStreamDefaultController",configurable:!0});class yn{constructor(e={},t={}){void 0===e?e=null:V(e,"First parameter");const r=gt(t,"Second parameter"),n=ln(e,"First parameter");if(Sn(this),"bytes"===n.type){if(void 0!==r.size)throw new RangeError("The strategy for a byte stream cannot have a size function");rt(this,n,mt(r,0))}else{const e=_t(r);rn(this,n,mt(r,1),e)}}get locked(){if(!En(this))throw Cn("locked");return Tn(this)}cancel(e=void 0){return En(this)?Tn(this)?f(new TypeError("Cannot cancel a stream that already has a reader")):Rn(this,e):f(Cn("cancel"))}getReader(e=void 0){if(!En(this))throw Cn("getReader");return void 0===fn(e,"First parameter").mode?ee(this):it(this)}pipeThrough(e,t={}){if(!En(this))throw Cn("pipeThrough");G(e,1,"pipeThrough");const r=bn(e,"First parameter"),n=_n(t,"Second parameter");if(Tn(this))throw new TypeError("ReadableStream.prototype.pipeThrough cannot be used on a locked ReadableStream");if(Dt(r.writable))throw new TypeError("ReadableStream.prototype.pipeThrough cannot be used on a locked WritableStream");return y(Mr(this,r.writable,n.preventClose,n.preventAbort,n.preventCancel,n.signal)),r.readable}pipeTo(e,t={}){if(!En(this))return f(Cn("pipeTo"));if(void 0===e)return f("Parameter 1 is required in 'pipeTo'.");if(!Lt(e))return f(new TypeError("ReadableStream.prototype.pipeTo's first argument must be a WritableStream"));let r;try{r=_n(t,"Second parameter")}catch(e){return f(e)}return Tn(this)?f(new TypeError("ReadableStream.prototype.pipeTo cannot be used on a locked ReadableStream")):Dt(e)?f(new TypeError("ReadableStream.prototype.pipeTo cannot be used on a locked WritableStream")):Mr(this,e,r.preventClose,r.preventAbort,r.preventCancel,r.signal)}tee(){if(!En(this))throw Cn("tee");return _e(on(this))}values(e=void 0){if(!En(this))throw Cn("values");return he(this,mn(e,"First parameter").preventCancel)}}function wn(e,t,r,n=1,o=(()=>1)){const s=Object.create(yn.prototype);return Sn(s),tn(s,Object.create(zr.prototype),e,t,r,n,o),s}function vn(e,t,r){const n=Object.create(yn.prototype);return Sn(n),tt(n,Object.create(Ce.prototype),e,t,r,0,void 0),n}function Sn(e){e._state="readable",e._reader=void 0,e._storedError=void 0,e._disturbed=!1}function En(e){return!!s(e)&&!!Object.prototype.hasOwnProperty.call(e,"_readableStreamController")&&e instanceof yn}function Tn(e){return void 0!==e._reader}function Rn(e,t){if(e._disturbed=!0,"closed"===e._state)return h(void 0);if("errored"===e._state)return f(e._storedError);kn(e);const n=e._reader;return void 0!==n&&ht(n)&&(n._readIntoRequests.forEach((e=>{e._closeSteps(void 0)})),n._readIntoRequests=new T),b(e._readableStreamController[j](t),r)}function kn(e){e._state="closed";const t=e._reader;void 0!==t&&(B(t),ie(t)&&(t._readRequests.forEach((e=>{e._closeSteps()})),t._readRequests=new T))}function Pn(e,t){e._state="errored",e._storedError=t;const r=e._reader;void 0!==r&&(D(r,t),ie(r)?(r._readRequests.forEach((e=>{e._errorSteps(t)})),r._readRequests=new T):(r._readIntoRequests.forEach((e=>{e._errorSteps(t)})),r._readIntoRequests=new T))}function Cn(e){return new TypeError(`ReadableStream.prototype.${e} can only be used on a ReadableStream`)}function On(e,t){M(e,t);const r=null==e?void 0:e.highWaterMark;return Y(r,"highWaterMark","QueuingStrategyInit"),{highWaterMark:K(r)}}Object.defineProperties(yn.prototype,{cancel:{enumerable:!0},getReader:{enumerable:!0},pipeThrough:{enumerable:!0},pipeTo:{enumerable:!0},tee:{enumerable:!0},values:{enumerable:!0},locked:{enumerable:!0}}),"symbol"==typeof t.toStringTag&&Object.defineProperty(yn.prototype,t.toStringTag,{value:"ReadableStream",configurable:!0}),"symbol"==typeof t.asyncIterator&&Object.defineProperty(yn.prototype,t.asyncIterator,{value:yn.prototype.values,writable:!0,configurable:!0});const xn=e=>e.byteLength;try{Object.defineProperty(xn,"name",{value:"size",configurable:!0})}catch(e){}class An{constructor(e){G(e,1,"ByteLengthQueuingStrategy"),e=On(e,"First parameter"),this._byteLengthQueuingStrategyHighWaterMark=e.highWaterMark}get highWaterMark(){if(!Dn(this))throw Ln("highWaterMark");return this._byteLengthQueuingStrategyHighWaterMark}get size(){if(!Dn(this))throw Ln("size");return xn}}function Ln(e){return new TypeError(`ByteLengthQueuingStrategy.prototype.${e} can only be used on a ByteLengthQueuingStrategy`)}function Dn(e){return!!s(e)&&!!Object.prototype.hasOwnProperty.call(e,"_byteLengthQueuingStrategyHighWaterMark")&&e instanceof An}Object.defineProperties(An.prototype,{highWaterMark:{enumerable:!0},size:{enumerable:!0}}),"symbol"==typeof t.toStringTag&&Object.defineProperty(An.prototype,t.toStringTag,{value:"ByteLengthQueuingStrategy",configurable:!0});const In=()=>1;try{Object.defineProperty(In,"name",{value:"size",configurable:!0})}catch(e){}class Bn{constructor(e){G(e,1,"CountQueuingStrategy"),e=On(e,"First parameter"),this._countQueuingStrategyHighWaterMark=e.highWaterMark}get highWaterMark(){if(!Un(this))throw $n("highWaterMark");return this._countQueuingStrategyHighWaterMark}get size(){if(!Un(this))throw $n("size");return In}}function $n(e){return new TypeError(`CountQueuingStrategy.prototype.${e} can only be used on a CountQueuingStrategy`)}function Un(e){return!!s(e)&&!!Object.prototype.hasOwnProperty.call(e,"_countQueuingStrategyHighWaterMark")&&e instanceof Bn}function jn(e,t){M(e,t);const r=null==e?void 0:e.flush,n=null==e?void 0:e.readableType,o=null==e?void 0:e.start,s=null==e?void 0:e.transform,i=null==e?void 0:e.writableType;return{flush:void 0===r?void 0:qn(r,e,`${t} has member 'flush' that`),readableType:n,start:void 0===o?void 0:Nn(o,e,`${t} has member 'start' that`),transform:void 0===s?void 0:Fn(s,e,`${t} has member 'transform' that`),writableType:i}}function qn(e,t,r){return z(e,r),r=>S(e,t,[r])}function Nn(e,t,r){return z(e,r),r=>v(e,t,[r])}function Fn(e,t,r){return z(e,r),(r,n)=>S(e,t,[r,n])}Object.defineProperties(Bn.prototype,{highWaterMark:{enumerable:!0},size:{enumerable:!0}}),"symbol"==typeof t.toStringTag&&Object.defineProperty(Bn.prototype,t.toStringTag,{value:"CountQueuingStrategy",configurable:!0});class Wn{constructor(e={},t={},r={}){void 0===e&&(e=null);const n=gt(t,"Second parameter"),o=gt(r,"Third parameter"),s=jn(e,"First parameter");if(void 0!==s.readableType)throw new RangeError("Invalid readableType specified");if(void 0!==s.writableType)throw new RangeError("Invalid writableType specified");const i=mt(o,0),a=_t(o),l=mt(n,1),c=_t(n);let u;Mn(this,d((e=>{u=e})),l,c,i,a),Jn(this,s),void 0!==s.start?u(s.start(this._transformStreamController)):u(void 0)}get readable(){if(!zn(this))throw lo("readable");return this._readable}get writable(){if(!zn(this))throw lo("writable");return this._writable}}function Mn(e,t,r,n,o,s){function i(){return t}function a(t){return no(e,t)}function l(t){return oo(e,t)}function c(){return so(e)}function u(){return io(e)}function d(t){return Vn(e,t),h(void 0)}e._writable=xt(i,a,c,l,r,n),e._readable=wn(i,u,d,o,s),e._backpressure=void 0,e._backpressureChangePromise=void 0,e._backpressureChangePromise_resolve=void 0,Gn(e,!0),e._transformStreamController=void 0}function zn(e){return!!s(e)&&!!Object.prototype.hasOwnProperty.call(e,"_transformStreamController")&&e instanceof Wn}function Hn(e,t){Jr(e._readable._readableStreamController,t),Vn(e,t)}function Vn(e,t){Xn(e._transformStreamController),gr(e._writable._writableStreamController,t),e._backpressure&&Gn(e,!1)}function Gn(e,t){void 0!==e._backpressureChangePromise&&e._backpressureChangePromise_resolve(),e._backpressureChangePromise=d((t=>{e._backpressureChangePromise_resolve=t})),e._backpressure=t}Object.defineProperties(Wn.prototype,{readable:{enumerable:!0},writable:{enumerable:!0}}),"symbol"==typeof t.toStringTag&&Object.defineProperty(Wn.prototype,t.toStringTag,{value:"TransformStream",configurable:!0});class Yn{constructor(){throw new TypeError("Illegal constructor")}get desiredSize(){if(!Kn(this))throw ao("desiredSize");return Xr(this._controlledTransformStream._readable._readableStreamController)}enqueue(e=void 0){if(!Kn(this))throw ao("enqueue");Zn(this,e)}error(e=void 0){if(!Kn(this))throw ao("error");eo(this,e)}terminate(){if(!Kn(this))throw ao("terminate");ro(this)}}function Kn(e){return!!s(e)&&!!Object.prototype.hasOwnProperty.call(e,"_controlledTransformStream")&&e instanceof Yn}function Qn(e,t,r,n){t._controlledTransformStream=e,e._transformStreamController=t,t._transformAlgorithm=r,t._flushAlgorithm=n}function Jn(e,t){const r=Object.create(Yn.prototype);let n=e=>{try{return Zn(r,e),h(void 0)}catch(e){return f(e)}},o=()=>h(void 0);void 0!==t.transform&&(n=e=>t.transform(e,r)),void 0!==t.flush&&(o=()=>t.flush(r)),Qn(e,r,n,o)}function Xn(e){e._transformAlgorithm=void 0,e._flushAlgorithm=void 0}function Zn(e,t){const r=e._controlledTransformStream,n=r._readable._readableStreamController;if(!en(n))throw new TypeError("Readable side is not in a state that permits enqueue");try{Qr(n,t)}catch(e){throw Vn(r,e),r._readable._storedError}Zr(n)!==r._backpressure&&Gn(r,!0)}function eo(e,t){Hn(e._controlledTransformStream,t)}function to(e,t){return b(e._transformAlgorithm(t),void 0,(t=>{throw Hn(e._controlledTransformStream,t),t}))}function ro(e){const t=e._controlledTransformStream;Kr(t._readable._readableStreamController),Vn(t,new TypeError("TransformStream terminated"))}function no(e,t){const r=e._transformStreamController;return e._backpressure?b(e._backpressureChangePromise,(()=>{const n=e._writable;if("erroring"===n._state)throw n._storedError;return to(r,t)})):to(r,t)}function oo(e,t){return Hn(e,t),h(void 0)}function so(e){const t=e._readable,r=e._transformStreamController,n=r._flushAlgorithm();return Xn(r),b(n,(()=>{if("errored"===t._state)throw t._storedError;Kr(t._readableStreamController)}),(r=>{throw Hn(e,r),t._storedError}))}function io(e){return Gn(e,!1),e._backpressureChangePromise}function ao(e){return new TypeError(`TransformStreamDefaultController.prototype.${e} can only be used on a TransformStreamDefaultController`)}function lo(e){return new TypeError(`TransformStream.prototype.${e} can only be used on a TransformStream`)}Object.defineProperties(Yn.prototype,{enqueue:{enumerable:!0},error:{enumerable:!0},terminate:{enumerable:!0},desiredSize:{enumerable:!0}}),"symbol"==typeof t.toStringTag&&Object.defineProperty(Yn.prototype,t.toStringTag,{value:"TransformStreamDefaultController",configurable:!0}),e.ByteLengthQueuingStrategy=An,e.CountQueuingStrategy=Bn,e.ReadableByteStreamController=Ce,e.ReadableStream=yn,e.ReadableStreamBYOBReader=dt,e.ReadableStreamBYOBRequest=Pe,e.ReadableStreamDefaultController=zr,e.ReadableStreamDefaultReader=se,e.TransformStream=Wn,e.TransformStreamDefaultController=Yn,e.WritableStream=Ct,e.WritableStreamDefaultController=ar,e.WritableStreamDefaultWriter=Qt,Object.defineProperty(e,"__esModule",{value:!0})}(Ir.exports)),Ir.exports))}try{const{Blob:e}=require("buffer");e&&!e.prototype.stream&&(e.prototype.stream=function(e){let t=0;const r=this;return new ReadableStream({type:"bytes",async pull(e){const n=r.slice(t,Math.min(r.size,t+65536)),o=await n.arrayBuffer();t+=o.byteLength,e.enqueue(new Uint8Array(o)),t===r.size&&e.close()}})})}catch(e){}
/*! fetch-blob. MIT License. Jimmy Wärting <https://jimmy.warting.se/opensource> */async function*Br(e,t=!0){for(const r of e)if("stream"in r)yield*r.stream();else if(ArrayBuffer.isView(r))if(t){let e=r.byteOffset;const t=r.byteOffset+r.byteLength;for(;e!==t;){const n=Math.min(t-e,65536),o=r.buffer.slice(e,e+n);e+=o.byteLength,yield new Uint8Array(o)}}else yield r;else{let e=0,t=r;for(;e!==t.size;){const r=t.slice(e,Math.min(t.size,e+65536)),n=await r.arrayBuffer();e+=n.byteLength,yield new Uint8Array(n)}}}const $r=class e{#e=[];#t="";#r=0;#n="transparent";constructor(t=[],r={}){if("object"!=typeof t||null===t)throw new TypeError("Failed to construct 'Blob': The provided value cannot be converted to a sequence.");if("function"!=typeof t[Symbol.iterator])throw new TypeError("Failed to construct 'Blob': The object must have a callable @@iterator property.");if("object"!=typeof r&&"function"!=typeof r)throw new TypeError("Failed to construct 'Blob': parameter 2 cannot convert to dictionary.");null===r&&(r={});const n=new TextEncoder;for(const r of t){let t;t=ArrayBuffer.isView(r)?new Uint8Array(r.buffer.slice(r.byteOffset,r.byteOffset+r.byteLength)):r instanceof ArrayBuffer?new Uint8Array(r.slice(0)):r instanceof e?r:n.encode(`${r}`),this.#r+=ArrayBuffer.isView(t)?t.byteLength:t.size,this.#e.push(t)}this.#n=`${void 0===r.endings?"transparent":r.endings}`;const o=void 0===r.type?"":String(r.type);this.#t=/^[\x20-\x7E]*$/.test(o)?o:""}get size(){return this.#r}get type(){return this.#t}async text(){const e=new TextDecoder;let t="";for await(const r of Br(this.#e,!1))t+=e.decode(r,{stream:!0});return t+=e.decode(),t}async arrayBuffer(){const e=new Uint8Array(this.size);let t=0;for await(const r of Br(this.#e,!1))e.set(r,t),t+=r.length;return e.buffer}stream(){const e=Br(this.#e,!0);return new globalThis.ReadableStream({type:"bytes",async pull(t){const r=await e.next();r.done?t.close():t.enqueue(r.value)},async cancel(){await e.return()}})}slice(t=0,r=this.size,n=""){const{size:o}=this;let s=t<0?Math.max(o+t,0):Math.min(t,o),i=r<0?Math.max(o+r,0):Math.min(r,o);const a=Math.max(i-s,0),l=this.#e,c=[];let u=0;for(const e of l){if(u>=a)break;const t=ArrayBuffer.isView(e)?e.byteLength:e.size;if(s&&t<=s)s-=t,i-=t;else{let r;ArrayBuffer.isView(e)?(r=e.subarray(s,Math.min(t,i)),u+=r.byteLength):(r=e.slice(s,Math.min(t,i)),u+=r.size),i-=t,c.push(r),s=0}}const d=new e([],{type:String(n).toLowerCase()});return d.#r=a,d.#e=c,d}get[Symbol.toStringTag](){return"Blob"}static[Symbol.hasInstance](e){return e&&"object"==typeof e&&"function"==typeof e.constructor&&("function"==typeof e.stream||"function"==typeof e.arrayBuffer)&&/^(Blob|File)$/.test(e[Symbol.toStringTag])}};Object.defineProperties($r.prototype,{size:{enumerable:!0},type:{enumerable:!0},slice:{enumerable:!0}});var Ur=$r;const jr=class extends Ur{#o=0;#s="";constructor(e,t,r={}){if(arguments.length<2)throw new TypeError(`Failed to construct 'File': 2 arguments required, but only ${arguments.length} present.`);super(e,r),null===r&&(r={});const n=void 0===r.lastModified?Date.now():Number(r.lastModified);Number.isNaN(n)||(this.#o=n),this.#s=String(t)}get name(){return this.#s}get lastModified(){return this.#o}get[Symbol.toStringTag](){return"File"}static[Symbol.hasInstance](e){return!!e&&e instanceof Ur&&/^(File)$/.test(e[Symbol.toStringTag])}};
/*! formdata-polyfill. MIT License. Jimmy Wärting <https://jimmy.warting.se/opensource> */
var{toStringTag:qr,iterator:Nr,hasInstance:Fr}=Symbol,Wr=Math.random,Mr="append,set,get,getAll,delete,keys,values,entries,forEach,constructor".split(","),zr=(e,t,r)=>(e+="",/^(Blob|File)$/.test(t&&t[qr])?[(r=void 0!==r?r+"":"File"==t[qr]?t.name:"blob",e),t.name!==r||"blob"==t[qr]?new jr([t],r,t):t]:[e,t+""]),Hr=(e,t)=>(t?e:e.replace(/\r?\n|\r/g,"\r\n")).replace(/\n/g,"%0A").replace(/\r/g,"%0D").replace(/"/g,"%22"),Vr=(e,t,r)=>{if(t.length<r)throw new TypeError(`Failed to execute '${e}' on 'FormData': ${r} arguments required, but only ${t.length} present.`)};const Gr=class{#i=[];constructor(...e){if(e.length)throw new TypeError("Failed to construct 'FormData': parameter 1 is not of type 'HTMLFormElement'.")}get[qr](){return"FormData"}[Nr](){return this.entries()}static[Fr](e){return e&&"object"==typeof e&&"FormData"===e[qr]&&!Mr.some((t=>"function"!=typeof e[t]))}append(...e){Vr("append",arguments,2),this.#i.push(zr(...e))}delete(e){Vr("delete",arguments,1),e+="",this.#i=this.#i.filter((([t])=>t!==e))}get(e){Vr("get",arguments,1),e+="";for(var t=this.#i,r=t.length,n=0;n<r;n++)if(t[n][0]===e)return t[n][1];return null}getAll(e,t){return Vr("getAll",arguments,1),t=[],e+="",this.#i.forEach((r=>r[0]===e&&t.push(r[1]))),t}has(e){return Vr("has",arguments,1),e+="",this.#i.some((t=>t[0]===e))}forEach(e,t){for(var[r,n]of(Vr("forEach",arguments,1),this))e.call(t,n,r,this)}set(...e){Vr("set",arguments,2);var t=[],r=!0;e=zr(...e),this.#i.forEach((n=>{n[0]===e[0]?r&&(r=!t.push(e)):t.push(n)})),r&&t.push(e),this.#i=t}*entries(){yield*this.#i}*keys(){for(var[e]of this)yield e}*values(){for(var[,e]of this)yield e}};class Yr extends Error{constructor(e,t){super(e),Error.captureStackTrace(this,this.constructor),this.type=t}get name(){return this.constructor.name}get[Symbol.toStringTag](){return this.constructor.name}}class Kr extends Yr{constructor(e,t,r){super(e,t),r&&(this.code=this.errno=r.code,this.erroredSysCall=r.syscall)}}const Qr=Symbol.toStringTag,Jr=e=>"object"==typeof e&&"function"==typeof e.append&&"function"==typeof e.delete&&"function"==typeof e.get&&"function"==typeof e.getAll&&"function"==typeof e.has&&"function"==typeof e.set&&"function"==typeof e.sort&&"URLSearchParams"===e[Qr],Xr=e=>e&&"object"==typeof e&&"function"==typeof e.arrayBuffer&&"string"==typeof e.type&&"function"==typeof e.stream&&"function"==typeof e.constructor&&/^(Blob|File)$/.test(e[Qr]),Zr=k(v.pipeline),en=Symbol("Body internals");class tn{constructor(e,{size:t=0}={}){let r=null;null===e?e=null:Jr(e)?e=T.from(e.toString()):Xr(e)||T.isBuffer(e)||(R.isAnyArrayBuffer(e)?e=T.from(e):ArrayBuffer.isView(e)?e=T.from(e.buffer,e.byteOffset,e.byteLength):e instanceof v||(e instanceof Gr?(e=function(e,t=Ur){var r=`${Wr()}${Wr()}`.replace(/\./g,"").slice(-28).padStart(32,"-"),n=[],o=`--${r}\r\nContent-Disposition: form-data; name="`;return e.forEach(((e,t)=>"string"==typeof e?n.push(o+Hr(t)+`"\r\n\r\n${e.replace(/\r(?!\n)|(?<!\r)\n/g,"\r\n")}\r\n`):n.push(o+Hr(t)+`"; filename="${Hr(e.name,1)}"\r\nContent-Type: ${e.type||"application/octet-stream"}\r\n\r\n`,e,"\r\n"))),n.push(`--${r}--`),new t(n,{type:"multipart/form-data; boundary="+r})}(e),r=e.type.split("=")[1]):e=T.from(String(e))));let n=e;T.isBuffer(e)?n=v.Readable.from(e):Xr(e)&&(n=v.Readable.from(e.stream())),this[en]={body:e,stream:n,boundary:r,disturbed:!1,error:null},this.size=t,e instanceof v&&e.on("error",(e=>{const t=e instanceof Yr?e:new Kr(`Invalid response body while trying to fetch ${this.url}: ${e.message}`,"system",e);this[en].error=t}))}get body(){return this[en].stream}get bodyUsed(){return this[en].disturbed}async arrayBuffer(){const{buffer:e,byteOffset:t,byteLength:r}=await rn(this);return e.slice(t,t+r)}async formData(){const e=this.headers.get("content-type");if(e.startsWith("application/x-www-form-urlencoded")){const e=new Gr,t=new URLSearchParams(await this.text());for(const[r,n]of t)e.append(r,n);return e}const{toFormData:t}=await Promise.resolve().then((function(){return In}));return t(this.body,e)}async blob(){const e=this.headers&&this.headers.get("content-type")||this[en].body&&this[en].body.type||"",t=await this.arrayBuffer();return new Ur([t],{type:e})}async json(){const e=await this.text();return JSON.parse(e)}async text(){const e=await rn(this);return(new TextDecoder).decode(e)}buffer(){return rn(this)}}async function rn(e){if(e[en].disturbed)throw new TypeError(`body used already for: ${e.url}`);if(e[en].disturbed=!0,e[en].error)throw e[en].error;const{body:t}=e;if(null===t)return T.alloc(0);if(!(t instanceof v))return T.alloc(0);const r=[];let n=0;try{for await(const o of t){if(e.size>0&&n+o.length>e.size){const r=new Kr(`content size at ${e.url} over limit: ${e.size}`,"max-size");throw t.destroy(r),r}n+=o.length,r.push(o)}}catch(t){throw t instanceof Yr?t:new Kr(`Invalid response body while trying to fetch ${e.url}: ${t.message}`,"system",t)}if(!0!==t.readableEnded&&!0!==t._readableState.ended)throw new Kr(`Premature close of server response while trying to fetch ${e.url}`);try{return r.every((e=>"string"==typeof e))?T.from(r.join("")):T.concat(r,n)}catch(t){throw new Kr(`Could not create Buffer from response body for ${e.url}: ${t.message}`,"system",t)}}tn.prototype.buffer=P(tn.prototype.buffer,"Please use 'response.arrayBuffer()' instead of 'response.buffer()'","node-fetch#buffer"),Object.defineProperties(tn.prototype,{body:{enumerable:!0},bodyUsed:{enumerable:!0},arrayBuffer:{enumerable:!0},blob:{enumerable:!0},json:{enumerable:!0},text:{enumerable:!0},data:{get:P((()=>{}),"data doesn't exist, use json(), text(), arrayBuffer(), or body instead","https://github.com/node-fetch/node-fetch/issues/1000 (response)")}});const nn=(e,t)=>{let r,n,{body:o}=e[en];if(e.bodyUsed)throw new Error("cannot clone body after it is used");return o instanceof v&&"function"!=typeof o.getBoundary&&(r=new S({highWaterMark:t}),n=new S({highWaterMark:t}),o.pipe(r),o.pipe(n),e[en].stream=r,o=n),o},on=P((e=>e.getBoundary()),"form-data doesn't follow the spec and requires special treatment. Use alternative package","https://github.com/node-fetch/node-fetch/issues/1167"),sn=(e,t)=>null===e?null:"string"==typeof e?"text/plain;charset=UTF-8":Jr(e)?"application/x-www-form-urlencoded;charset=UTF-8":Xr(e)?e.type||null:T.isBuffer(e)||R.isAnyArrayBuffer(e)||ArrayBuffer.isView(e)?null:e instanceof Gr?`multipart/form-data; boundary=${t[en].boundary}`:e&&"function"==typeof e.getBoundary?`multipart/form-data;boundary=${on(e)}`:e instanceof v?null:"text/plain;charset=UTF-8",an="function"==typeof b.validateHeaderName?b.validateHeaderName:e=>{if(!/^[\^`\-\w!#$%&'*+.|~]+$/.test(e)){const t=new TypeError(`Header name must be a valid HTTP token [${e}]`);throw Object.defineProperty(t,"code",{value:"ERR_INVALID_HTTP_TOKEN"}),t}},ln="function"==typeof b.validateHeaderValue?b.validateHeaderValue:(e,t)=>{if(/[^\t\u0020-\u007E\u0080-\u00FF]/.test(t)){const t=new TypeError(`Invalid character in header content ["${e}"]`);throw Object.defineProperty(t,"code",{value:"ERR_INVALID_CHAR"}),t}};class cn extends URLSearchParams{constructor(e){let t=[];if(e instanceof cn){const r=e.raw();for(const[e,n]of Object.entries(r))t.push(...n.map((t=>[e,t])))}else if(null==e);else{if("object"!=typeof e||R.isBoxedPrimitive(e))throw new TypeError("Failed to construct 'Headers': The provided value is not of type '(sequence<sequence<ByteString>> or record<ByteString, ByteString>)");{const r=e[Symbol.iterator];if(null==r)t.push(...Object.entries(e));else{if("function"!=typeof r)throw new TypeError("Header pairs must be iterable");t=[...e].map((e=>{if("object"!=typeof e||R.isBoxedPrimitive(e))throw new TypeError("Each header pair must be an iterable object");return[...e]})).map((e=>{if(2!==e.length)throw new TypeError("Each header pair must be a name/value tuple");return[...e]}))}}}return t=t.length>0?t.map((([e,t])=>(an(e),ln(e,String(t)),[String(e).toLowerCase(),String(t)]))):void 0,super(t),new Proxy(this,{get(e,t,r){switch(t){case"append":case"set":return(r,n)=>(an(r),ln(r,String(n)),URLSearchParams.prototype[t].call(e,String(r).toLowerCase(),String(n)));case"delete":case"has":case"getAll":return r=>(an(r),URLSearchParams.prototype[t].call(e,String(r).toLowerCase()));case"keys":return()=>(e.sort(),new Set(URLSearchParams.prototype.keys.call(e)).keys());default:return Reflect.get(e,t,r)}}})}get[Symbol.toStringTag](){return this.constructor.name}toString(){return Object.prototype.toString.call(this)}get(e){const t=this.getAll(e);if(0===t.length)return null;let r=t.join(", ");return/^content-encoding$/i.test(e)&&(r=r.toLowerCase()),r}forEach(e,t=void 0){for(const r of this.keys())Reflect.apply(e,t,[this.get(r),r,this])}*values(){for(const e of this.keys())yield this.get(e)}*entries(){for(const e of this.keys())yield[e,this.get(e)]}[Symbol.iterator](){return this.entries()}raw(){return[...this.keys()].reduce(((e,t)=>(e[t]=this.getAll(t),e)),{})}[Symbol.for("nodejs.util.inspect.custom")](){return[...this.keys()].reduce(((e,t)=>{const r=this.getAll(t);return e[t]="host"===t?r[0]:r.length>1?r:r[0],e}),{})}}Object.defineProperties(cn.prototype,["get","entries","forEach","values"].reduce(((e,t)=>(e[t]={enumerable:!0},e)),{}));const un=new Set([301,302,303,307,308]),dn=e=>un.has(e),hn=Symbol("Response internals");class fn extends tn{constructor(e=null,t={}){super(e,t);const r=null!=t.status?t.status:200,n=new cn(t.headers);if(null!==e&&!n.has("Content-Type")){const t=sn(e,this);t&&n.append("Content-Type",t)}this[hn]={type:"default",url:t.url,status:r,statusText:t.statusText||"",headers:n,counter:t.counter,highWaterMark:t.highWaterMark}}get type(){return this[hn].type}get url(){return this[hn].url||""}get status(){return this[hn].status}get ok(){return this[hn].status>=200&&this[hn].status<300}get redirected(){return this[hn].counter>0}get statusText(){return this[hn].statusText}get headers(){return this[hn].headers}get highWaterMark(){return this[hn].highWaterMark}clone(){return new fn(nn(this,this.highWaterMark),{type:this.type,url:this.url,status:this.status,statusText:this.statusText,headers:this.headers,ok:this.ok,redirected:this.redirected,size:this.size,highWaterMark:this.highWaterMark})}static redirect(e,t=302){if(!dn(t))throw new RangeError('Failed to execute "redirect" on "response": Invalid status code');return new fn(null,{headers:{location:new URL(e).toString()},status:t})}static error(){const e=new fn(null,{status:0,statusText:""});return e[hn].type="error",e}static json(e=void 0,t={}){const r=JSON.stringify(e);if(void 0===r)throw new TypeError("data is not JSON serializable");const n=new cn(t&&t.headers);return n.has("content-type")||n.set("content-type","application/json"),new fn(r,{...t,headers:n})}get[Symbol.toStringTag](){return"Response"}}Object.defineProperties(fn.prototype,{type:{enumerable:!0},url:{enumerable:!0},status:{enumerable:!0},ok:{enumerable:!0},redirected:{enumerable:!0},statusText:{enumerable:!0},headers:{enumerable:!0},clone:{enumerable:!0}});function pn(e,t=!1){return null==e?"no-referrer":(e=new URL(e),/^(about|blob|data):$/.test(e.protocol)?"no-referrer":(e.username="",e.password="",e.hash="",t&&(e.pathname="",e.search=""),e))}const mn=new Set(["","no-referrer","no-referrer-when-downgrade","same-origin","origin","strict-origin","origin-when-cross-origin","strict-origin-when-cross-origin","unsafe-url"]);function _n(e){return!!/^about:(blank|srcdoc)$/.test(e)||("data:"===e.protocol||(!!/^(blob|filesystem):$/.test(e.protocol)||function(e){if(/^(http|ws)s:$/.test(e.protocol))return!0;const t=e.host.replace(/(^\[)|(]$)/g,""),r=O(t);return!(4!==r||!/^127\./.test(t))||!(6!==r||!/^(((0+:){7})|(::(0+:){0,6}))0*1$/.test(t))||"localhost"!==e.host&&!e.host.endsWith(".localhost")&&"file:"===e.protocol}(e)))}const gn=Symbol("Request internals"),bn=e=>"object"==typeof e&&"object"==typeof e[gn],yn=P((()=>{}),".data is not a valid RequestInit property, use .body instead","https://github.com/node-fetch/node-fetch/issues/1000 (request)");class wn extends tn{constructor(e,t={}){let r;if(bn(e)?r=new URL(e.url):(r=new URL(e),e={}),""!==r.username||""!==r.password)throw new TypeError(`${r} is an url with embedded credentials.`);let n=t.method||e.method||"GET";if(/^(delete|get|head|options|post|put)$/i.test(n)&&(n=n.toUpperCase()),!bn(t)&&"data"in t&&yn(),(null!=t.body||bn(e)&&null!==e.body)&&("GET"===n||"HEAD"===n))throw new TypeError("Request with GET/HEAD method cannot have body");const o=t.body?t.body:bn(e)&&null!==e.body?nn(e):null;super(o,{size:t.size||e.size||0});const s=new cn(t.headers||e.headers||{});if(null!==o&&!s.has("Content-Type")){const e=sn(o,this);e&&s.set("Content-Type",e)}let i=bn(e)?e.signal:null;if("signal"in t&&(i=t.signal),null!=i&&("object"!=typeof(a=i)||"AbortSignal"!==a[Qr]&&"EventTarget"!==a[Qr]))throw new TypeError("Expected signal to be an instanceof AbortSignal or EventTarget");var a;let l=null==t.referrer?e.referrer:t.referrer;if(""===l)l="no-referrer";else if(l){const e=new URL(l);l=/^about:(\/\/)?client$/.test(e)?"client":e}else l=void 0;this[gn]={method:n,redirect:t.redirect||e.redirect||"follow",headers:s,parsedURL:r,signal:i,referrer:l},this.follow=void 0===t.follow?void 0===e.follow?20:e.follow:t.follow,this.compress=void 0===t.compress?void 0===e.compress||e.compress:t.compress,this.counter=t.counter||e.counter||0,this.agent=t.agent||e.agent,this.highWaterMark=t.highWaterMark||e.highWaterMark||16384,this.insecureHTTPParser=t.insecureHTTPParser||e.insecureHTTPParser||!1,this.referrerPolicy=t.referrerPolicy||e.referrerPolicy||""}get method(){return this[gn].method}get url(){return C(this[gn].parsedURL)}get headers(){return this[gn].headers}get redirect(){return this[gn].redirect}get signal(){return this[gn].signal}get referrer(){return"no-referrer"===this[gn].referrer?"":"client"===this[gn].referrer?"about:client":this[gn].referrer?this[gn].referrer.toString():void 0}get referrerPolicy(){return this[gn].referrerPolicy}set referrerPolicy(e){this[gn].referrerPolicy=function(e){if(!mn.has(e))throw new TypeError(`Invalid referrerPolicy: ${e}`);return e}(e)}clone(){return new wn(this)}get[Symbol.toStringTag](){return"Request"}}Object.defineProperties(wn.prototype,{method:{enumerable:!0},url:{enumerable:!0},headers:{enumerable:!0},redirect:{enumerable:!0},clone:{enumerable:!0},signal:{enumerable:!0},referrer:{enumerable:!0},referrerPolicy:{enumerable:!0}});const vn=e=>{const{parsedURL:t}=e[gn],r=new cn(e[gn].headers);r.has("Accept")||r.set("Accept","*/*");let n=null;if(null===e.body&&/^(post|put)$/i.test(e.method)&&(n="0"),null!==e.body){const t=(e=>{const{body:t}=e[en];return null===t?0:Xr(t)?t.size:T.isBuffer(t)?t.length:t&&"function"==typeof t.getLengthSync&&t.hasKnownLength&&t.hasKnownLength()?t.getLengthSync():null})(e);"number"!=typeof t||Number.isNaN(t)||(n=String(t))}n&&r.set("Content-Length",n),""===e.referrerPolicy&&(e.referrerPolicy="strict-origin-when-cross-origin"),e.referrer&&"no-referrer"!==e.referrer?e[gn].referrer=function(e,{referrerURLCallback:t,referrerOriginCallback:r}={}){if("no-referrer"===e.referrer||""===e.referrerPolicy)return null;const n=e.referrerPolicy;if("about:client"===e.referrer)return"no-referrer";const o=e.referrer;let s=pn(o),i=pn(o,!0);s.toString().length>4096&&(s=i),t&&(s=t(s)),r&&(i=r(i));const a=new URL(e.url);switch(n){case"no-referrer":return"no-referrer";case"origin":return i;case"unsafe-url":return s;case"strict-origin":return _n(s)&&!_n(a)?"no-referrer":i.toString();case"strict-origin-when-cross-origin":return s.origin===a.origin?s:_n(s)&&!_n(a)?"no-referrer":i;case"same-origin":return s.origin===a.origin?s:"no-referrer";case"origin-when-cross-origin":return s.origin===a.origin?s:i;case"no-referrer-when-downgrade":return _n(s)&&!_n(a)?"no-referrer":s;default:throw new TypeError(`Invalid referrerPolicy: ${n}`)}}(e):e[gn].referrer="no-referrer",e[gn].referrer instanceof URL&&r.set("Referer",e.referrer),r.has("User-Agent")||r.set("User-Agent","node-fetch"),e.compress&&!r.has("Accept-Encoding")&&r.set("Accept-Encoding","gzip, deflate, br");let{agent:o}=e;"function"==typeof o&&(o=o(t));const s=(e=>{if(e.search)return e.search;const t=e.href.length-1,r=e.hash||("#"===e.href[t]?"#":"");return"?"===e.href[t-r.length]?"?":""})(t);return{parsedURL:t,options:{path:t.pathname+s,method:e.method,headers:r[Symbol.for("nodejs.util.inspect.custom")](),insecureHTTPParser:e.insecureHTTPParser,agent:o}}};class Sn extends Yr{constructor(e,t="aborted"){super(e,t)}}
/*! node-domexception. MIT License. Jimmy Wärting <https://jimmy.warting.se/opensource> */if(!globalThis.DOMException)try{const{MessageChannel:e}=require("worker_threads"),t=(new e).port1,r=new ArrayBuffer;t.postMessage(r,[r,r])}catch(e){"DOMException"===e.constructor.name&&(globalThis.DOMException=e.constructor)}const En=new Set(["data:","http:","https:"]);async function Tn(e,t){return new Promise(((r,n)=>{const o=new wn(e,t),{parsedURL:s,options:i}=vn(o);if(!En.has(s.protocol))throw new TypeError(`node-fetch cannot load ${e}. URL scheme "${s.protocol.replace(/:$/,"")}" is not supported.`);if("data:"===s.protocol){const e=function(e){if(!/^data:/i.test(e))throw new TypeError('`uri` does not appear to be a Data URI (must begin with "data:")');const t=(e=e.replace(/\r?\n/g,"")).indexOf(",");if(-1===t||t<=4)throw new TypeError("malformed data: URI");const r=e.substring(5,t).split(";");let n="",o=!1;const s=r[0]||"text/plain";let i=s;for(let e=1;e<r.length;e++)"base64"===r[e]?o=!0:r[e]&&(i+=`;${r[e]}`,0===r[e].indexOf("charset=")&&(n=r[e].substring(8)));r[0]||n.length||(i+=";charset=US-ASCII",n="US-ASCII");const a=o?"base64":"ascii",l=unescape(e.substring(t+1)),c=Buffer.from(l,a);return c.type=s,c.typeFull=i,c.charset=n,c}(o.url),t=new fn(e,{headers:{"Content-Type":e.typeFull}});return void r(t)}const a=("https:"===s.protocol?y:b).request,{signal:l}=o;let c=null;const u=()=>{const e=new Sn("The operation was aborted.");n(e),o.body&&o.body instanceof v.Readable&&o.body.destroy(e),c&&c.body&&c.body.emit("error",e)};if(l&&l.aborted)return void u();const d=()=>{u(),f()},h=a(s.toString(),i);l&&l.addEventListener("abort",d);const f=()=>{h.abort(),l&&l.removeEventListener("abort",d)};h.on("error",(e=>{n(new Kr(`request to ${o.url} failed, reason: ${e.message}`,"system",e)),f()})),function(e,t){const r=T.from("0\r\n\r\n");let n,o=!1,s=!1;e.on("response",(e=>{const{headers:t}=e;o="chunked"===t["transfer-encoding"]&&!t["content-length"]})),e.on("socket",(i=>{const a=()=>{if(o&&!s){const e=new Error("Premature close");e.code="ERR_STREAM_PREMATURE_CLOSE",t(e)}},l=e=>{s=0===T.compare(e.slice(-5),r),!s&&n&&(s=0===T.compare(n.slice(-3),r.slice(0,3))&&0===T.compare(e.slice(-2),r.slice(3))),n=e};i.prependListener("close",a),i.on("data",l),e.on("close",(()=>{i.removeListener("close",a),i.removeListener("data",l)}))}))}(h,(e=>{c&&c.body&&c.body.destroy(e)})),process.version<"v14"&&h.on("socket",(e=>{let t;e.prependListener("end",(()=>{t=e._eventsCount})),e.prependListener("close",(r=>{if(c&&t<e._eventsCount&&!r){const e=new Error("Premature close");e.code="ERR_STREAM_PREMATURE_CLOSE",c.body.emit("error",e)}}))})),h.on("response",(e=>{h.setTimeout(0);const s=function(e=[]){return new cn(e.reduce(((e,t,r,n)=>(r%2==0&&e.push(n.slice(r,r+2)),e)),[]).filter((([e,t])=>{try{return an(e),ln(e,String(t)),!0}catch{return!1}})))}(e.rawHeaders);if(dn(e.statusCode)){const a=s.get("Location");let l=null;try{l=null===a?null:new URL(a,o.url)}catch{if("manual"!==o.redirect)return n(new Kr(`uri requested responds with an invalid redirect URL: ${a}`,"invalid-redirect")),void f()}switch(o.redirect){case"error":return n(new Kr(`uri requested responds with a redirect, redirect mode is set to error: ${o.url}`,"no-redirect")),void f();case"manual":break;case"follow":{if(null===l)break;if(o.counter>=o.follow)return n(new Kr(`maximum redirect reached at: ${o.url}`,"max-redirect")),void f();const a={headers:new cn(o.headers),follow:o.follow,counter:o.counter+1,agent:o.agent,compress:o.compress,method:o.method,body:nn(o),signal:o.signal,size:o.size,referrer:o.referrer,referrerPolicy:o.referrerPolicy};if(!((e,t)=>{const r=new URL(t).hostname,n=new URL(e).hostname;return r===n||r.endsWith(`.${n}`)})(o.url,l)||(i=o.url,new URL(l).protocol!==new URL(i).protocol))for(const e of["authorization","www-authenticate","cookie","cookie2"])a.headers.delete(e);if(303!==e.statusCode&&o.body&&t.body instanceof v.Readable)return n(new Kr("Cannot follow redirect with body being a readable stream","unsupported-redirect")),void f();303!==e.statusCode&&(301!==e.statusCode&&302!==e.statusCode||"POST"!==o.method)||(a.method="GET",a.body=void 0,a.headers.delete("content-length"));const c=function(e){const t=(e.get("referrer-policy")||"").split(/[,\s]+/);let r="";for(const e of t)e&&mn.has(e)&&(r=e);return r}(s);return c&&(a.referrerPolicy=c),r(Tn(new wn(l,a))),void f()}default:return n(new TypeError(`Redirect option '${o.redirect}' is not a valid value of RequestRedirect`))}}var i;l&&e.once("end",(()=>{l.removeEventListener("abort",d)}));let a=E(e,new S,(e=>{e&&n(e)}));process.version<"v12.10"&&e.on("aborted",d);const u={url:o.url,status:e.statusCode,statusText:e.statusMessage,headers:s,size:o.size,counter:o.counter,highWaterMark:o.highWaterMark},p=s.get("Content-Encoding");if(!o.compress||"HEAD"===o.method||null===p||204===e.statusCode||304===e.statusCode)return c=new fn(a,u),void r(c);const m={flush:w.Z_SYNC_FLUSH,finishFlush:w.Z_SYNC_FLUSH};if("gzip"===p||"x-gzip"===p)return a=E(a,w.createGunzip(m),(e=>{e&&n(e)})),c=new fn(a,u),void r(c);if("deflate"===p||"x-deflate"===p){const t=E(e,new S,(e=>{e&&n(e)}));return t.once("data",(e=>{a=8==(15&e[0])?E(a,w.createInflate(),(e=>{e&&n(e)})):E(a,w.createInflateRaw(),(e=>{e&&n(e)})),c=new fn(a,u),r(c)})),void t.once("end",(()=>{c||(c=new fn(a,u),r(c))}))}if("br"===p)return a=E(a,w.createBrotliDecompress(),(e=>{e&&n(e)})),c=new fn(a,u),void r(c);c=new fn(a,u),r(c)})),(async(e,{body:t})=>{null===t?e.end():await Zr(t,e)})(h,o).catch(n)}))}let Rn=(()=>{let e,t,r=[Cr({UUID:"com.johnlong.beeminder.monitor"})],n=[],o=Or;return class extends o{static{t=this}static{const s="function"==typeof Symbol&&Symbol.metadata?Object.create(o[Symbol.metadata]??null):void 0;!function(e,t,r,n,o,s){function i(e){if(void 0!==e&&"function"!=typeof e)throw new TypeError("Function expected");return e}for(var a,l=n.kind,c="getter"===l?"get":"setter"===l?"set":"value",u=!t&&e?n.static?e:e.prototype:null,d=t||(u?Object.getOwnPropertyDescriptor(u,n.name):{}),h=!1,f=r.length-1;f>=0;f--){var p={};for(var m in n)p[m]="access"===m?{}:n[m];for(var m in n.access)p.access[m]=n.access[m];p.addInitializer=function(e){if(h)throw new TypeError("Cannot add initializers after decoration has completed");s.push(i(e||null))};var _=(0,r[f])("accessor"===l?{get:d.get,set:d.set}:d[c],p);if("accessor"===l){if(void 0===_)continue;if(null===_||"object"!=typeof _)throw new TypeError("Object expected");(a=i(_.get))&&(d.get=a),(a=i(_.set))&&(d.set=a),(a=i(_.init))&&o.unshift(a)}else(a=i(_))&&("field"===l?o.unshift(a):d[c]=a)}u&&Object.defineProperty(u,n.name,d),h=!0}(null,e={value:t},r,{kind:"class",name:t.name,metadata:s},null,n),t=e.value,s&&Object.defineProperty(t,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:s}),function(e,t,r){for(var n=arguments.length>2,o=0;o<t.length;o++)r=n?t[o].call(e,r):t[o].call(e)}(t,n)}logger=Lr.logger.createScope("Monitor");onWillAppear(e){return setInterval((()=>{this.logger.debug("Timer fired"),this.updateButton(e.payload.settings.slug,e.action)}),6e4),e.action.getSettings().then((t=>{if(t.slug)return this.updateButton(t.slug,e.action)}))}async onKeyDown(e){return this.updateButton(e.payload.settings.slug,e.action)}async updateButton(e,t){const r=await Lr.settings.getGlobalSettings(),n=await this.getGoalData(r.apiToken,e),o=await t.getSettings();let s=this.getButtonSvg(n,o.progressBarCutoff||99);return t.setImage("data:image/svg+xml;charset=utf8,"+s)}getButtonSvg(e,t){const r=(e,t,r)=>Math.min(t/(.45*e.length),r),n=e.limsum.split(" "),o=n[0],s=n.slice(1).join(" ");return`<svg width="144" height="144" xmlns="http://www.w3.org/2000/svg">\n    <rect width="144" height="144" fill="${e.roadstatuscolor}" />\n    <text x="72" y="40" dominant-baseline="middle" text-anchor="middle" fill="#000" font-size="${r(o,140,30)}px" font-family="Tahoma">${o}</text>\n    <text x="72" y="82" dominant-baseline="middle" text-anchor="middle" fill="#000" font-size="${r(s,140,40)}px" font-family="Tahoma">${s}</text>`+this.getProgressBar(e,t)+`<text x="72" y="135" dominant-baseline="middle" text-anchor="middle" fill="#000" font-size="${r(e.slug,140,28)}px" font-family="Tahoma">${e.slug}</text>\n    </svg>`}getProgressBar(e,t){const r=this.getProgressWidth(e,120),n=t>e.safebuf;return this.logger.debug(`shouldIncludeBar: ${n}`),this.logger.debug(`progressBarCutoff: ${t}, safebuf: ${e.safebuf}`),n?`<rect x="12" y="100" width="120" height="10" fill="lightgrey" />\n   <rect x="12" y="100" width="${r}" height="10" fill="${e.roadstatuscolor}" />`:""}getProgressWidth(e,t=134){let r=new Date(1e3*e.curday).toISOString().slice(0,10).replace(/-/g,"");const n=e.recent_data.filter((e=>e.daystamp===r)).reduce(((e,t)=>e+t.value),0),o=this.getDaysInPeriod(e.graphsum.split(" ").pop()),s=n/Math.ceil(e.currate/o);return Math.round(t*s)}async getGoalData(e,t){let r=`https://www.beeminder.com/api/v1/users/me/goals/${t}.json?auth_token=${e}`;this.logger.debug(`Fetching goal data from ${r}`);const n=await Tn(r);if(!n.ok)throw this.logger.error(`Error fetching goal data: ${n.statusText}`),new Error(`Error fetching goal data: ${n.statusText}`);return this.logger.debug(`Got response: ${JSON.stringify(n)}`),await n.json()}onDidReceiveSettings(e){return this.updateButton(e.payload.settings.slug,e.action)}getDaysInPeriod(e){switch(e){case"day":default:return 1;case"week":return 7;case"month":return 30;case"year":return 365}}},t})();Lr.logger.setLevel(gr.TRACE),Lr.actions.registerAction(new Rn),Lr.connect();let kn=0;const Pn={START_BOUNDARY:kn++,HEADER_FIELD_START:kn++,HEADER_FIELD:kn++,HEADER_VALUE_START:kn++,HEADER_VALUE:kn++,HEADER_VALUE_ALMOST_DONE:kn++,HEADERS_ALMOST_DONE:kn++,PART_DATA_START:kn++,PART_DATA:kn++,END:kn++};let Cn=1;const On=Cn,xn=Cn*=2,An=e=>32|e,Ln=()=>{};class Dn{constructor(e){this.index=0,this.flags=0,this.onHeaderEnd=Ln,this.onHeaderField=Ln,this.onHeadersEnd=Ln,this.onHeaderValue=Ln,this.onPartBegin=Ln,this.onPartData=Ln,this.onPartEnd=Ln,this.boundaryChars={},e="\r\n--"+e;const t=new Uint8Array(e.length);for(let r=0;r<e.length;r++)t[r]=e.charCodeAt(r),this.boundaryChars[t[r]]=!0;this.boundary=t,this.lookbehind=new Uint8Array(this.boundary.length+8),this.state=Pn.START_BOUNDARY}write(e){let t=0;const r=e.length;let n=this.index,{lookbehind:o,boundary:s,boundaryChars:i,index:a,state:l,flags:c}=this;const u=this.boundary.length,d=u-1,h=e.length;let f,p;const m=e=>{this[e+"Mark"]=t},_=e=>{delete this[e+"Mark"]},g=(e,t,r,n)=>{void 0!==t&&t===r||this[e](n&&n.subarray(t,r))},b=(r,n)=>{const o=r+"Mark";o in this&&(n?(g(r,this[o],t,e),delete this[o]):(g(r,this[o],e.length,e),this[o]=0))};for(t=0;t<r;t++)switch(f=e[t],l){case Pn.START_BOUNDARY:if(a===s.length-2){if(45===f)c|=xn;else if(13!==f)return;a++;break}if(a-1==s.length-2){if(c&xn&&45===f)l=Pn.END,c=0;else{if(c&xn||10!==f)return;a=0,g("onPartBegin"),l=Pn.HEADER_FIELD_START}break}f!==s[a+2]&&(a=-2),f===s[a+2]&&a++;break;case Pn.HEADER_FIELD_START:l=Pn.HEADER_FIELD,m("onHeaderField"),a=0;case Pn.HEADER_FIELD:if(13===f){_("onHeaderField"),l=Pn.HEADERS_ALMOST_DONE;break}if(a++,45===f)break;if(58===f){if(1===a)return;b("onHeaderField",!0),l=Pn.HEADER_VALUE_START;break}if(p=An(f),p<97||p>122)return;break;case Pn.HEADER_VALUE_START:if(32===f)break;m("onHeaderValue"),l=Pn.HEADER_VALUE;case Pn.HEADER_VALUE:13===f&&(b("onHeaderValue",!0),g("onHeaderEnd"),l=Pn.HEADER_VALUE_ALMOST_DONE);break;case Pn.HEADER_VALUE_ALMOST_DONE:if(10!==f)return;l=Pn.HEADER_FIELD_START;break;case Pn.HEADERS_ALMOST_DONE:if(10!==f)return;g("onHeadersEnd"),l=Pn.PART_DATA_START;break;case Pn.PART_DATA_START:l=Pn.PART_DATA,m("onPartData");case Pn.PART_DATA:if(n=a,0===a){for(t+=d;t<h&&!(e[t]in i);)t+=u;t-=d,f=e[t]}if(a<s.length)s[a]===f?(0===a&&b("onPartData",!0),a++):a=0;else if(a===s.length)a++,13===f?c|=On:45===f?c|=xn:a=0;else if(a-1===s.length)if(c&On){if(a=0,10===f){c&=~On,g("onPartEnd"),g("onPartBegin"),l=Pn.HEADER_FIELD_START;break}}else c&xn&&45===f?(g("onPartEnd"),l=Pn.END,c=0):a=0;if(a>0)o[a-1]=f;else if(n>0){const e=new Uint8Array(o.buffer,o.byteOffset,o.byteLength);g("onPartData",0,n,e),n=0,m("onPartData"),t--}break;case Pn.END:break;default:throw new Error(`Unexpected state entered: ${l}`)}b("onHeaderField"),b("onHeaderValue"),b("onPartData"),this.index=a,this.state=l,this.flags=c}end(){if(this.state===Pn.HEADER_FIELD_START&&0===this.index||this.state===Pn.PART_DATA&&this.index===this.boundary.length)this.onPartEnd();else if(this.state!==Pn.END)throw new Error("MultipartParser.end(): stream ended unexpectedly")}}var In=Object.freeze({__proto__:null,toFormData:async function(e,t){if(!/multipart/i.test(t))throw new TypeError("Failed to fetch");const r=t.match(/boundary=(?:"([^"]+)"|([^;]+))/i);if(!r)throw new TypeError("no or bad content-type header, no multipart boundary");const n=new Dn(r[1]||r[2]);let o,s,i,a,l,c;const u=[],d=new Gr,h=e=>{i+=_.decode(e,{stream:!0})},f=e=>{u.push(e)},p=()=>{const e=new jr(u,c,{type:l});d.append(a,e)},m=()=>{d.append(a,i)},_=new TextDecoder("utf-8");_.decode(),n.onPartBegin=function(){n.onPartData=h,n.onPartEnd=m,o="",s="",i="",a="",l="",c=null,u.length=0},n.onHeaderField=function(e){o+=_.decode(e,{stream:!0})},n.onHeaderValue=function(e){s+=_.decode(e,{stream:!0})},n.onHeaderEnd=function(){if(s+=_.decode(),o=o.toLowerCase(),"content-disposition"===o){const e=s.match(/\bname=("([^"]*)"|([^()<>@,;:\\"/[\]?={}\s\t]+))/i);e&&(a=e[2]||e[3]||""),c=function(e){const t=e.match(/\bfilename=("(.*?)"|([^()<>@,;:\\"/[\]?={}\s\t]+))($|;\s)/i);if(!t)return;const r=t[2]||t[3]||"";let n=r.slice(r.lastIndexOf("\\")+1);return n=n.replace(/%22/g,'"'),n=n.replace(/&#(\d{4});/g,((e,t)=>String.fromCharCode(t))),n}(s),c&&(n.onPartData=f,n.onPartEnd=p)}else"content-type"===o&&(l=s);s="",o=""};for await(const t of e)n.write(t);return n.end(),d}});
